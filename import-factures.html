<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Import Factures</title>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#fafafa; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 18px; background:#fff; border-bottom:1px solid #e5e5e5; position:sticky; top:0; z-index:100; flex-wrap:wrap; }
    .btn { cursor:pointer; border:1px solid #ddd; background:#fff; padding:10px 12px; border-radius:10px; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    main { max-width: 980px; margin: 18px auto; padding: 0 14px; }
    .card { background:#fff; border:1px solid #e5e5e5; border-radius:14px; padding:14px; margin-bottom:14px; }
    .drop { border:2px dashed #bbb; border-radius:14px; padding:22px; text-align:center; background:#fcfcfc; }
    .drop.drag { border-color:#333; background:#fff; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #eee; padding:10px 8px; text-align:left; font-size:14px; vertical-align:top; }
    th { font-size:12px; text-transform:uppercase; letter-spacing:.04em; color:#666; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #ddd; font-size:12px; }
    .ok { border-color:#9ad39a; }
    .err { border-color:#ffb3b3; }
    .muted { color:#666; font-size:13px; }
    .row-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; }
    .notice { background:#fff7d6; border:1px solid #f1d88a; padding:10px 12px; border-radius:12px; margin-bottom:14px; }
    .small { font-size:12px; }
    input[type="file"] { max-width: 100%; }
    .field { border:1px solid #ddd; border-radius:10px; padding:10px 12px; background:#fff; }
    .authBox { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .msg { padding:10px 12px; border-radius:12px; border:1px solid #e5e5e5; background:#fff; }
    .msg.ok { border-color:#9ad39a; background:#f2fff2; }
    .msg.err { border-color:#ffb3b3; background:#fff2f2; }
    .msg.warn { border-color:#f1d88a; background:#fff7d6; }

    /* Highlight */
    mark.hl { background:#ffe58f; padding:0 2px; border-radius:4px; }
    mark.hl[data-label] { border-bottom:2px solid #ffb300; cursor:help; }
    .hlBox { display:flex; gap:10px; flex-wrap:wrap; padding:10px 12px; border:1px solid #eee; border-radius:12px; background:#fafafa; margin:10px 0; }
    .hlTag { border:1px solid #ddd; border-radius:999px; padding:4px 8px; font-size:12px; background:#fff; }

    /* ‚úÖ Modal robust */
    #textModal {
      display:none;
      position:fixed; inset:0;
      background:rgba(0,0,0,.5);
      align-items:center; justify-content:center;
      padding:18px;
      z-index:9999;
      pointer-events:auto;
    }
    #textModal .modalBox {
      width:min(980px, 95vw);
      max-height:85vh;
      background:#fff;
      border-radius:14px;
      border:1px solid #e5e5e5;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>

<body>
  <header>
    <div style="display:flex; align-items:center; gap:10px;">
      <button class="btn" id="backBtn">‚¨ÖÔ∏è Retour</button>
      <strong>üì§ Import Factures</strong>
    </div>

    <div class="authBox">
      <span class="muted" id="authStatus">Connexion‚Ä¶</span>
      <input class="field" id="emailInput" type="email" placeholder="Email" style="min-width:220px;">
      <input class="field" id="passInput" type="password" placeholder="Mot de passe" style="min-width:160px;">
      <button class="btn" id="loginBtn">Se connecter</button>
      <button class="btn" id="logoutBtn" disabled>Se d√©connecter</button>
    </div>
  </header>

  <main>
    <div class="notice">
      <div><strong>Info :</strong> upload ‚Üí extraction texte ‚Üí parsing auto ‚Üí insertion lignes.</div>
      <div class="muted small">Le viewer peut √™tre ouvert autant de fois que souhait√©.</div>
    </div>

    <div id="globalMsg" class="msg warn" style="display:none; margin-bottom:14px;"></div>

    <div class="card">
      <div class="drop" id="dropZone">
        <div style="font-size:18px; margin-bottom:6px;">Glisse-d√©pose tes PDFs ici</div>
        <div class="muted">PDF uniquement ‚Ä¢ max 10 MB/fichier ‚Ä¢ max 20 fichiers</div>
        <div style="margin-top:12px;">
          <input type="file" id="fileInput" accept="application/pdf" multiple />
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" id="startUploadBtn" disabled>üöÄ Uploader & Traiter</button>
        <button class="btn" id="clearBtn" disabled>üßπ Vider la liste</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <strong>üìÑ Fichiers s√©lectionn√©s</strong>
        <span class="muted" id="selectedCount">0</span>
      </div>

      <div style="overflow:auto; margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>Fichier</th>
              <th>Taille</th>
              <th>Statut</th>
              <th>Facture ID</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="filesTbody">
            <tr><td colspan="5" class="muted">Aucun fichier</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="./supabase-core.js"></script>
  <script src="./supabase-services.js"></script>

  <script>
    // --------------------------
    // Helpers
    // --------------------------
    const MAX_FILES = 20;
    const MAX_SIZE = 10 * 1024 * 1024;

    function setMsg(type, text) {
      const box = document.getElementById("globalMsg");
      box.className = "msg " + (type || "warn");
      box.textContent = text || "";
      box.style.display = text ? "block" : "none";
    }
    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + " B";
      const kb = bytes / 1024;
      if (kb < 1024) return kb.toFixed(1) + " KB";
      return (kb / 1024).toFixed(1) + " MB";
    }
    function isPdf(file) { return file.type === "application/pdf" || file.name.toLowerCase().endsWith(".pdf"); }
    function sanitizeFilename(name) { return name.replace(/[^a-zA-Z0-9.\-_]/g, "_").replace(/_{2,}/g, "_"); }

    function escapeHtml(s) {
      return (s || "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }
    function escapeRegex(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); }

    // --------------------------
    // Highlight (am√©lior√©)
    // --------------------------
    function normalizeMoneyTokens(value) {
      // cr√©e des variantes pour surligner (avec espaces, sans ‚Ç¨, etc.)
      const v = String(value || "").trim();
      if (!v) return [];
      const base = v.replace("‚Ç¨","").trim();
      const noSpace = base.replace(/\s/g, "");
      return [...new Set([v, base, noSpace])].filter(x => x.length >= 3);
    }

    function highlightText(rawText, highlights) {
      let html = escapeHtml(rawText);
      const sorted = [...highlights].sort((a,b) => (b.value.length - a.value.length));

      for (const h of sorted) {
        const token = (h.value || "").trim();
        if (!token || token.length < 3) continue;
        const re = new RegExp(escapeRegex(token), "g");
        html = html.replace(re, m =>
          `<mark class="hl" data-label="${escapeHtml(h.label)}" title="${escapeHtml(h.label)}">${escapeHtml(m)}</mark>`
        );
      }
      return html;
    }

    function renderHighlightsBox(data, highlights) {
      const box = document.getElementById("hlBox");
      if (!box) return;

      const tags = [];
      if (data.numero_facture) tags.push(`<span class="hlTag"># ${escapeHtml(String(data.numero_facture))}</span>`);
      if (data.date_facture) tags.push(`<span class="hlTag">üìÖ ${escapeHtml(String(data.date_facture))}</span>`);
      if (data.client_nom) tags.push(`<span class="hlTag">üë§ ${escapeHtml(String(data.client_nom))}</span>`);
      if (typeof data.total_ht === "number") tags.push(`<span class="hlTag">HT ${escapeHtml(String(data.total_ht))}</span>`);
      if (typeof data.total_ttc === "number") tags.push(`<span class="hlTag">TTC ${escapeHtml(String(data.total_ttc))}</span>`);

      // ‚úÖ debug : combien de tokens
      tags.push(`<span class="hlTag">üîé tokens: ${highlights.length}</span>`);

      box.innerHTML = tags.join(" ");
    }

    function buildHighlightsFromDB(data) {
      const hl = [];

      // Champs colonnes
      if (data.numero_facture) hl.push({ label:"Num√©ro facture", value:String(data.numero_facture) });
      if (data.client_nom) hl.push({ label:"Client", value:String(data.client_nom) });

      // ‚úÖ Dates : on utilise le match texte stock√© dans donnees_brutes.matches (ex "17 f√©vrier 2025")
      const matches = data?.donnees_brutes?.matches || [];
      for (const m of matches) {
        if (!m?.value) continue;

        // date_facture en toutes lettres (surlignage direct)
        hl.push({ label: m.label, value: String(m.value) });

        // montants : ajoute variantes (sans espaces / sans ‚Ç¨)
        if (m.label.startsWith("total_")) {
          const vars = normalizeMoneyTokens(m.value);
          for (const v of vars) hl.push({ label: m.label, value: v });
        }
      }

      // Si totaux sont en colonnes mais pas pr√©sents dans matches, ajoute tokens
      if (typeof data.total_ht === "number") {
        for (const v of normalizeMoneyTokens(data.total_ht.toFixed(2).replace(".", ","))) hl.push({ label:"total_ht", value:v });
      }
      if (typeof data.total_tva === "number") {
        for (const v of normalizeMoneyTokens(data.total_tva.toFixed(2).replace(".", ","))) hl.push({ label:"total_tva", value:v });
      }
      if (typeof data.total_ttc === "number") {
        for (const v of normalizeMoneyTokens(data.total_ttc.toFixed(2).replace(".", ","))) hl.push({ label:"total_ttc", value:v });
      }

      // d√©dupe
      const seen = new Set();
      return hl.filter(x => {
        const key = x.label + "::" + x.value;
        if (seen.has(key)) return false;
        seen.add(key);
        return (x.value || "").trim().length >= 3;
      });
    }

    // --------------------------
    // State
    // --------------------------
    const state = { files: [] };

    // --------------------------
    // UI
    // --------------------------
    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("fileInput");
    const startUploadBtn = document.getElementById("startUploadBtn");
    const clearBtn = document.getElementById("clearBtn");
    const filesTbody = document.getElementById("filesTbody");
    const selectedCount = document.getElementById("selectedCount");

    const authStatus = document.getElementById("authStatus");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const emailInput = document.getElementById("emailInput");
    const passInput = document.getElementById("passInput");

    document.getElementById("backBtn").onclick = () => window.location.href = "index.html";

    async function waitForSupabaseClient() {
      for (let i = 0; i < 60; i++) {
        if (window.SupabaseClient) return window.SupabaseClient;
        await new Promise(r => setTimeout(r, 100));
      }
      throw new Error("SupabaseClient non initialis√© (timeout)");
    }

    let sb;

    (async () => {
      try {
        sb = await waitForSupabaseClient();
        if (window.pdfjsLib?.GlobalWorkerOptions) {
          window.pdfjsLib.GlobalWorkerOptions.workerSrc =
            "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
        }
        initApp();
      } catch (e) {
        console.error(e);
        setMsg("err", "Supabase non initialis√©. Recharge la page.");
      }
    })();

    function initApp() {
      async function refreshAuthStatus() {
        const { data: { user } } = await sb.auth.getUser();
        if (user) {
          authStatus.textContent = "Connect√©: " + (user.email || user.id);
          logoutBtn.disabled = false;
          emailInput.style.display = "none";
          passInput.style.display = "none";
          loginBtn.style.display = "none";
          setMsg("", "");
        } else {
          authStatus.textContent = "Non connect√©";
          logoutBtn.disabled = true;
          emailInput.style.display = "";
          passInput.style.display = "";
          loginBtn.style.display = "";
          setMsg("warn", "Connecte-toi pour uploader.");
        }
        render();
      }

      loginBtn.onclick = async () => {
        const email = (emailInput.value || "").trim();
        const password = passInput.value || "";
        if (!email || !password) return setMsg("warn", "Email et mot de passe requis.");
        setMsg("warn", "Connexion‚Ä¶");
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) return setMsg("err", "Erreur login: " + error.message);
        passInput.value = "";
        await refreshAuthStatus();
        setMsg("ok", "‚úÖ Connect√©.");
      };

      logoutBtn.onclick = async () => { await sb.auth.signOut(); await refreshAuthStatus(); };
      sb.auth.onAuthStateChange(() => refreshAuthStatus());
      refreshAuthStatus();

      async function ensureLoggedIn() {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) throw new Error("Non connect√©");
        return user;
      }

      function render() {
        selectedCount.textContent = String(state.files.length);
        const anyBusy = state.files.some(f => ["uploading","extracting"].includes(f.status));
        startUploadBtn.disabled = state.files.length === 0 || anyBusy;
        clearBtn.disabled = state.files.length === 0 || anyBusy;

        filesTbody.innerHTML = "";
        if (state.files.length === 0) {
          filesTbody.innerHTML = `<tr><td colspan="5" class="muted">Aucun fichier</td></tr>`;
          return;
        }

        for (let i = 0; i < state.files.length; i++) {
          const item = state.files[i];
          const pill = (() => {
            if (item.status === "ready") return `<span class="pill">pr√™t</span>`;
            if (item.status === "uploading") return `<span class="pill">upload‚Ä¶</span>`;
            if (item.status === "extracting") return `<span class="pill">traitement‚Ä¶</span>`;
            if (item.status === "extracted") return `<span class="pill ok">OK</span>`;
            if (item.status === "error") return `<span class="pill err">erreur</span>`;
            return `<span class="pill">${item.status}</span>`;
          })();

          filesTbody.insertAdjacentHTML("beforeend", `
            <tr>
              <td>${escapeHtml(item.file.name)}${item.error ? `<div class="muted" style="color:#b00020;">${escapeHtml(item.error)}</div>` : ""}</td>
              <td>${formatBytes(item.file.size)}</td>
              <td>${pill}</td>
              <td>${item.factureId ? `<span class="mono">${item.factureId}</span>` : `<span class="muted">‚Äî</span>`}</td>
              <td>
                <div class="row-actions">
                  <button class="btn" data-action="remove" data-index="${i}" ${item.status==="uploading" ? "disabled":""}>Retirer</button>
                  <button class="btn" data-action="viewText" data-index="${i}" ${item.status!=="extracted" ? "disabled":""}>üëÅ Voir texte</button>
                </div>
              </td>
            </tr>
          `);
        }

        filesTbody.querySelectorAll("button[data-action]").forEach(btn => {
          btn.onclick = async () => {
            const idx = Number(btn.getAttribute("data-index"));
            const action = btn.getAttribute("data-action");
            if (action === "remove") { state.files.splice(idx, 1); render(); return; }
            if (action === "viewText") { await openTextViewer(idx); return; }
          };
        });
      }

      function addFiles(fileList) {
        const incoming = Array.from(fileList);
        for (const file of incoming) {
          if (state.files.length >= MAX_FILES) break;
          if (!isPdf(file)) { state.files.push({ file, status:"error", error:"PDF uniquement" }); continue; }
          if (file.size > MAX_SIZE) { state.files.push({ file, status:"error", error:"Max 10MB" }); continue; }
          state.files.push({ file, status:"ready", error:null, factureId:null, uploadPath:null });
        }
        render();
      }

      fileInput.addEventListener("change", (e) => addFiles(e.target.files));
      dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.classList.add("drag"); });
      dropZone.addEventListener("dragleave", () => dropZone.classList.remove("drag"));
      dropZone.addEventListener("drop", (e) => {
        e.preventDefault(); dropZone.classList.remove("drag");
        if (e.dataTransfer?.files) addFiles(e.dataTransfer.files);
      });
      clearBtn.onclick = () => { state.files = []; render(); };

      // ‚ö†Ô∏è Ici on ne refait pas tout le pipeline dans ce snippet : tu gardes ton pipeline existant.
      // L'important ici est le correctif viewer + surlignage + modal.
      // (Si tu veux, je fusionne aussi ton pipeline complet dans ce fichier version finale.)

      startUploadBtn.onclick = async () => {
        setMsg("warn", "‚ö†Ô∏è Ton pipeline upload/extraction/parsing est d√©j√† dans ta version 'structur√©'. Garde-le, ici on corrige surtout le viewer/surlignage.");
      };

      // --------------------------
      // ‚úÖ MODAL ROBUST (multi-open)
      // --------------------------
      const textModal = document.getElementById("textModal");
      const modalBox = document.getElementById("modalBox");
      const closeTextBtn = document.getElementById("closeTextBtn");
      const copyTextBtn = document.getElementById("copyTextBtn");
      const textContent = document.getElementById("textContent");
      const textMeta = document.getElementById("textMeta");

      function closeModal() {
        textModal.style.display = "none";
        document.body.style.overflow = ""; // restore scroll
      }

      closeTextBtn.onclick = (e) => { e.preventDefault(); closeModal(); };

      // clic overlay -> ferme
      textModal.addEventListener("click", (e) => {
        if (e.target === textModal) closeModal();
      });

      // clic dans la box -> ne ferme pas
      modalBox.addEventListener("click", (e) => e.stopPropagation());

      // ESC -> ferme
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && textModal.style.display === "flex") closeModal();
      });

      copyTextBtn.onclick = async () => {
        try {
          await navigator.clipboard.writeText(textContent.textContent || "");
          copyTextBtn.textContent = "‚úÖ Copi√©";
          setTimeout(() => copyTextBtn.textContent = "üìã Copier", 900);
        } catch {
          setMsg("warn", "Copie impossible (permission navigateur).");
        }
      };

      async function openTextViewer(idx) {
        const item = state.files[idx];
        if (!item?.factureId) return;

        try {
          const { data, error } = await sb
            .from("factures")
            .select("id,fichier_nom,statut,texte_ocr,created_at,donnees_brutes,numero_facture,date_facture,total_ht,total_tva,total_ttc,client_nom")
            .eq("id", item.factureId)
            .single();

          if (error) throw error;

          textMeta.innerHTML = `
            <div><strong>Facture ID :</strong> <span class="mono">${escapeHtml(data.id)}</span></div>
            <div><strong>Fichier :</strong> ${escapeHtml(data.fichier_nom || "‚Äî")}</div>
            <div><strong>Statut :</strong> <span class="mono">${escapeHtml(data.statut || "‚Äî")}</span></div>
            <div><strong>Cr√©√© le :</strong> ${escapeHtml(data.created_at || "‚Äî")}</div>
          `;

          const rawText = (data.texte_ocr || "").trim();
          const highlights = buildHighlightsFromDB(data);
          renderHighlightsBox(data, highlights);

          textContent.innerHTML = highlightText(rawText || "‚ö†Ô∏è Aucun texte.", highlights);

          textModal.style.display = "flex";
          document.body.style.overflow = "hidden"; // bloque le scroll derri√®re
        } catch (e) {
          setMsg("err", "Erreur lecture texte: " + (e?.message || e));
        }
      }

      // initial render
      render();
    }
  </script>

  <!-- ‚úÖ MODALE -->
  <div id="textModal">
    <div class="modalBox" id="modalBox">
      <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #eee;">
        <strong>üßæ Texte extrait (surlign√©)</strong>
        <div style="display:flex; gap:8px;">
          <button class="btn" id="copyTextBtn">üìã Copier</button>
          <button class="btn" id="closeTextBtn">‚úñ Fermer</button>
        </div>
      </div>
      <div style="padding:12px 14px; overflow:auto;">
        <div class="muted" id="textMeta" style="margin-bottom:10px;"></div>
        <div id="hlBox" class="hlBox"></div>
        <div id="textContent" style="
          white-space:pre-wrap; word-break:break-word;
          background:#fafafa; border:1px solid #eee; border-radius:12px;
          padding:12px; font-size:13px; line-height:1.35;"></div>
      </div>
    </div>
  </div>
</body>
</html>
