<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Import Factures</title>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#fafafa; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 18px; background:#fff; border-bottom:1px solid #e5e5e5; position:sticky; top:0; z-index:100; flex-wrap:wrap; }
    .btn { cursor:pointer; border:1px solid #ddd; background:#fff; padding:10px 12px; border-radius:10px; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    main { max-width: 980px; margin: 18px auto; padding: 0 14px; }
    .card { background:#fff; border:1px solid #e5e5e5; border-radius:14px; padding:14px; margin-bottom:14px; }
    .drop { border:2px dashed #bbb; border-radius:14px; padding:22px; text-align:center; background:#fcfcfc; }
    .drop.drag { border-color:#333; background:#fff; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #eee; padding:10px 8px; text-align:left; font-size:14px; vertical-align:top; }
    th { font-size:12px; text-transform:uppercase; letter-spacing:.04em; color:#666; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #ddd; font-size:12px; }
    .ok { border-color:#9ad39a; }
    .err { border-color:#ffb3b3; }
    .muted { color:#666; font-size:13px; }
    .row-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; }
    .notice { background:#fff7d6; border:1px solid #f1d88a; padding:10px 12px; border-radius:12px; margin-bottom:14px; }
    .small { font-size:12px; }
    input[type="file"] { max-width: 100%; }
    .field { border:1px solid #ddd; border-radius:10px; padding:10px 12px; background:#fff; }
    .authBox { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .msg { padding:10px 12px; border-radius:12px; border:1px solid #e5e5e5; background:#fff; }
    .msg.ok { border-color:#9ad39a; background:#f2fff2; }
    .msg.err { border-color:#ffb3b3; background:#fff2f2; }
    .msg.warn { border-color:#f1d88a; background:#fff7d6; }
  </style>

  <!-- ‚úÖ PDF.js (extraction texte pour PDF num√©riques) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>

<body>
  <header>
    <div style="display:flex; align-items:center; gap:10px;">
      <button class="btn" id="backBtn">‚¨ÖÔ∏è Retour</button>
      <strong>üì§ Import Factures (Upload + Extraction auto)</strong>
    </div>

    <div class="authBox">
      <span class="muted" id="authStatus">Connexion‚Ä¶</span>

      <!-- Login inline (sans prompt) -->
      <input class="field" id="emailInput" type="email" placeholder="Email" style="min-width:220px;">
      <input class="field" id="passInput" type="password" placeholder="Mot de passe" style="min-width:160px;">
      <button class="btn" id="loginBtn">Se connecter</button>
      <button class="btn" id="logoutBtn" disabled>Se d√©connecter</button>
    </div>
  </header>

  <main>
    <div class="notice">
      <div><strong>Important :</strong> bucket <span class="mono">factures</span> = <strong>priv√©</strong> ‚Üí il faut √™tre connect√© pour uploader.</div>
      <div class="muted">Apr√®s upload : extraction texte PDF automatique ‚Üí DB (<span class="mono">factures.texte_ocr</span>) + statut <span class="mono">extracted</span>.</div>
      <div class="muted small" style="margin-top:6px;">‚ö†Ô∏è Si un PDF est un scan (image), l‚Äôextraction native sera vide ‚Üí on ajoutera un fallback OCR plus tard.</div>
    </div>

    <!-- Zone message globale (sans popup) -->
    <div id="globalMsg" class="msg warn" style="display:none; margin-bottom:14px;"></div>

    <div class="card">
      <div class="drop" id="dropZone">
        <div style="font-size:18px; margin-bottom:6px;">Glisse-d√©pose tes PDFs ici</div>
        <div class="muted">PDF uniquement ‚Ä¢ max 10 MB/fichier ‚Ä¢ max 20 fichiers</div>
        <div style="margin-top:12px;">
          <input type="file" id="fileInput" accept="application/pdf" multiple />
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" id="startUploadBtn" disabled>üöÄ Uploader & Extraire</button>
        <button class="btn" id="clearBtn" disabled>üßπ Vider la liste</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <strong>üìÑ Fichiers s√©lectionn√©s</strong>
        <span class="muted" id="selectedCount">0</span>
      </div>

      <div style="overflow:auto; margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>Fichier</th>
              <th>Taille</th>
              <th>Statut</th>
              <th>Facture ID</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="filesTbody">
            <tr><td colspan="5" class="muted">Aucun fichier</td></tr>
          </tbody>
        </table>
      </div>

      <p class="muted" style="margin-top:10px;">
        Le bouton <span class="mono">üëÅ Voir texte</span> affiche le texte enregistr√© dans Supabase (champ <span class="mono">texte_ocr</span>).
      </p>
    </div>
  </main>

  <!-- ‚úÖ Option 2 stable : core + services -->
  <script src="./supabase-core.js"></script>
  <script src="./supabase-services.js"></script>

  <script>
    // -----------------------------
    // Helpers
    // -----------------------------
    const MAX_FILES = 20;
    const MAX_SIZE = 10 * 1024 * 1024;

    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + " B";
      const kb = bytes / 1024;
      if (kb < 1024) return kb.toFixed(1) + " KB";
      return (kb / 1024).toFixed(1) + " MB";
    }
    function isPdf(file) {
      return file.type === "application/pdf" || file.name.toLowerCase().endsWith(".pdf");
    }
    function sanitizeFilename(name) {
      return name.replace(/[^a-zA-Z0-9.\-_]/g, "_").replace(/_{2,}/g, "_");
    }

    function setMsg(type, text) {
      const box = document.getElementById("globalMsg");
      box.className = "msg " + (type || "warn");
      box.textContent = text || "";
      box.style.display = text ? "block" : "none";
    }

    // -----------------------------
    // State
    // -----------------------------
    const state = { files: [] }; // { file, status, error, factureId, uploadPath }

    // -----------------------------
    // UI
    // -----------------------------
    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("fileInput");
    const startUploadBtn = document.getElementById("startUploadBtn");
    const clearBtn = document.getElementById("clearBtn");
    const filesTbody = document.getElementById("filesTbody");
    const selectedCount = document.getElementById("selectedCount");

    const authStatus = document.getElementById("authStatus");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const emailInput = document.getElementById("emailInput");
    const passInput = document.getElementById("passInput");

    document.getElementById("backBtn").onclick = () => {
      // adapte si besoin
      window.location.href = "index.html";
    };

    // -----------------------------
    // Wait Supabase
    // -----------------------------
    async function waitForSupabaseClient() {
      for (let i = 0; i < 60; i++) {
        if (window.SupabaseClient) return window.SupabaseClient;
        await new Promise(r => setTimeout(r, 100));
      }
      throw new Error("SupabaseClient non initialis√© (timeout)");
    }

    let sb;

    // Init app when Supabase ready
    (async () => {
      try {
        sb = await waitForSupabaseClient();

        // PDF.js worker
        if (window.pdfjsLib?.GlobalWorkerOptions) {
          window.pdfjsLib.GlobalWorkerOptions.workerSrc =
            "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
        }

        initApp();
      } catch (e) {
        console.error(e);
        setMsg("err", "Supabase non initialis√©. Recharge la page.");
      }
    })();

    // -----------------------------
    // App
    // -----------------------------
    function initApp() {

      // Auth
      async function refreshAuthStatus() {
        const { data: { user } } = await sb.auth.getUser();
        if (user) {
          authStatus.textContent = "Connect√©: " + (user.email || user.id);
          logoutBtn.disabled = false;

          // hide login fields when connected
          emailInput.style.display = "none";
          passInput.style.display = "none";
          loginBtn.style.display = "none";
          setMsg("", "");
        } else {
          authStatus.textContent = "Non connect√©";
          logoutBtn.disabled = true;

          emailInput.style.display = "";
          passInput.style.display = "";
          loginBtn.style.display = "";
          setMsg("warn", "Connecte-toi pour uploader dans le bucket priv√©.");
        }
        render();
      }

      loginBtn.onclick = async () => {
        try {
          const email = (emailInput.value || "").trim();
          const password = passInput.value || "";
          if (!email || !password) {
            setMsg("warn", "Email et mot de passe requis.");
            return;
          }

          setMsg("warn", "Connexion en cours‚Ä¶");
          const { error } = await sb.auth.signInWithPassword({ email, password });
          if (error) {
            setMsg("err", "Erreur login: " + error.message);
            return;
          }
          passInput.value = "";
          await refreshAuthStatus();
          setMsg("ok", "‚úÖ Connect√©.");
        } catch (e) {
          setMsg("err", "Erreur login: " + (e?.message || e));
        }
      };

      logoutBtn.onclick = async () => {
        await sb.auth.signOut();
        await refreshAuthStatus();
      };

      sb.auth.onAuthStateChange(() => refreshAuthStatus());
      refreshAuthStatus();

      async function ensureLoggedIn() {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) throw new Error("Non connect√©");
        return user;
      }

      // Render
      function render() {
        selectedCount.textContent = String(state.files.length);

        const anyBusy = state.files.some(f => ["uploading","extracting"].includes(f.status));
        startUploadBtn.disabled = state.files.length === 0 || anyBusy;
        clearBtn.disabled = state.files.length === 0 || anyBusy;

        filesTbody.innerHTML = "";
        if (state.files.length === 0) {
          filesTbody.innerHTML = `<tr><td colspan="5" class="muted">Aucun fichier</td></tr>`;
          return;
        }

        for (let i = 0; i < state.files.length; i++) {
          const item = state.files[i];

          const statusPill = (() => {
            if (item.status === "ready") return `<span class="pill">pr√™t</span>`;
            if (item.status === "uploading") return `<span class="pill">upload‚Ä¶</span>`;
            if (item.status === "uploaded") return `<span class="pill ok">upload√©</span>`;
            if (item.status === "extracting") return `<span class="pill">extraction‚Ä¶</span>`;
            if (item.status === "extracted") return `<span class="pill ok">extracted</span>`;
            if (item.status === "error") return `<span class="pill err">erreur</span>`;
            return `<span class="pill">${item.status}</span>`;
          })();

          const factureId = item.factureId ? `<span class="mono">${item.factureId}</span>` : `<span class="muted">‚Äî</span>`;

          filesTbody.insertAdjacentHTML("beforeend", `
            <tr>
              <td>
                ${item.file.name}
                ${item.error ? `<div class="muted" style="color:#b00020;">${item.error}</div>` : ""}
              </td>
              <td>${formatBytes(item.file.size)}</td>
              <td>${statusPill}</td>
              <td>${factureId}</td>
              <td>
                <div class="row-actions">
                  <button class="btn" ${item.status==="uploading" ? "disabled" : ""} data-action="remove" data-index="${i}">Retirer</button>
                  <button class="btn" ${item.status!=="extracted" ? "disabled" : ""} data-action="viewText" data-index="${i}">üëÅ Voir texte</button>
                </div>
              </td>
            </tr>
          `);
        }

        filesTbody.querySelectorAll("button[data-action]").forEach(btn => {
          btn.onclick = async () => {
            const idx = Number(btn.getAttribute("data-index"));
            const action = btn.getAttribute("data-action");

            if (action === "remove") {
              state.files.splice(idx, 1);
              render();
              return;
            }

            if (action === "viewText") {
              await openTextViewer(idx);
              return;
            }
          };
        });
      }

      // Add files
      function addFiles(fileList) {
        const incoming = Array.from(fileList);
        for (const file of incoming) {
          if (state.files.length >= MAX_FILES) break;
          if (!isPdf(file)) { state.files.push({ file, status:"error", error:"PDF uniquement" }); continue; }
          if (file.size > MAX_SIZE) { state.files.push({ file, status:"error", error:"Max 10MB" }); continue; }
          state.files.push({ file, status:"ready", error:null, factureId:null, uploadPath:null });
        }
        render();
      }

      fileInput.addEventListener("change", (e) => addFiles(e.target.files));
      dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.classList.add("drag"); });
      dropZone.addEventListener("dragleave", () => dropZone.classList.remove("drag"));
      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("drag");
        if (e.dataTransfer?.files) addFiles(e.dataTransfer.files);
      });

      clearBtn.onclick = () => { state.files = []; render(); };

      // Upload + auto extract
      async function uploadAndExtractOne(item) {
        item.status = "uploading";
        item.error = null;
        render();

        try {
          await ensureLoggedIn();

          // 1) Upload storage
          const year = new Date().getFullYear();
          const ts = Date.now();
          const filename = `${ts}_${sanitizeFilename(item.file.name)}`;
          const path = `${year}/${filename}`;

          const { data: up, error: upErr } = await sb
            .storage
            .from("factures")
            .upload(path, item.file, { upsert:false, cacheControl:"3600", contentType:"application/pdf" });

          if (upErr) throw upErr;

          item.uploadPath = up.path;

          // 2) Insert DB row
          const { data: inserted, error: dbErr } = await sb
            .from("factures")
            .insert({ fichier_url: up.path, fichier_nom: item.file.name, statut:"pending", format_facture:"moderne" })
            .select("id")
            .single();

          if (dbErr) throw dbErr;

          item.factureId = inserted.id;
          item.status = "uploaded";
          render();

          // 3) Auto extraction
          await extractTextForItem(item);

        } catch (err) {
          item.status = "error";
          item.error = err?.message || String(err);
          render();
        }
      }

      // Extraction texte (PDF num√©rique) - no popup
      async function extractTextForItem(item) {
        item.status = "extracting";
        item.error = null;
        render();

        try {
          await ensureLoggedIn();

          const { data: signed, error: signErr } = await sb
            .storage
            .from("factures")
            .createSignedUrl(item.uploadPath, 60 * 10);

          if (signErr) throw signErr;

          const res = await fetch(signed.signedUrl);
          if (!res.ok) throw new Error("T√©l√©chargement PDF impossible (signed URL)");
          const arrayBuffer = await res.arrayBuffer();

          const loadingTask = window.pdfjsLib.getDocument({ data: arrayBuffer });
          const pdf = await loadingTask.promise;

          let fullText = "";
          for (let p = 1; p <= pdf.numPages; p++) {
            const page = await pdf.getPage(p);
            const content = await page.getTextContent();
            const pageText = content.items.map(it => it.str).join(" ");
            fullText += `\n\n=== PAGE ${p} ===\n` + pageText;
          }

          fullText = fullText.trim();
          if (fullText.length < 30) {
            throw new Error("Texte extrait vide/trop court (PDF scan ?)");
          }

          const { error: updErr } = await sb
            .from("factures")
            .update({ texte_ocr: fullText, statut: "extracted" })
            .eq("id", item.factureId);

          if (updErr) throw updErr;

          item.status = "extracted";
          render();

        } catch (err) {
          item.status = "error";
          item.error = err?.message || String(err);
          render();

          // log DB error (silent)
          if (item.factureId) {
            await sb.from("factures")
              .update({ statut:"error", error_message:item.error })
              .eq("id", item.factureId);
          }
        }
      }

      startUploadBtn.onclick = async () => {
        try {
          await ensureLoggedIn();
        } catch {
          setMsg("warn", "Connecte-toi d‚Äôabord pour uploader.");
          return;
        }

        setMsg("warn", "Traitement en cours : upload + extraction automatique‚Ä¶");
        const toProcess = state.files.filter(f => f.status === "ready");

        for (const item of toProcess) {
          await uploadAndExtractOne(item);
        }

        // message final
        const okCount = state.files.filter(f => f.status === "extracted").length;
        const errCount = state.files.filter(f => f.status === "error").length;

        if (errCount === 0) setMsg("ok", `‚úÖ Termin√© : ${okCount} facture(s) upload√©e(s) + texte extrait.`);
        else setMsg("err", `‚ö†Ô∏è Termin√© : ${okCount} OK, ${errCount} en erreur (voir la colonne fichier).`);
      };

      // Viewer (modale)
      const textModal = document.getElementById("textModal");
      const closeTextBtn = document.getElementById("closeTextBtn");
      const copyTextBtn = document.getElementById("copyTextBtn");
      const textContent = document.getElementById("textContent");
      const textMeta = document.getElementById("textMeta");

      closeTextBtn.onclick = () => { textModal.style.display = "none"; };
      textModal.addEventListener("click", (e) => { if (e.target === textModal) textModal.style.display = "none"; });

      copyTextBtn.onclick = async () => {
        try {
          await navigator.clipboard.writeText(textContent.textContent || "");
          copyTextBtn.textContent = "‚úÖ Copi√©";
          setTimeout(() => (copyTextBtn.textContent = "üìã Copier"), 900);
        } catch {
          setMsg("warn", "Copie impossible (permission navigateur).");
        }
      };

      async function openTextViewer(idx) {
        const item = state.files[idx];
        if (!item?.factureId) return;

        try {
          // ‚úÖ FIX: pas de updated_at (colonne inexistante)
          const { data, error } = await sb
            .from("factures")
            .select("id,fichier_nom,statut,texte_ocr,created_at")
            .eq("id", item.factureId)
            .single();

          if (error) throw error;

          textMeta.innerHTML = `
            <div><strong>Facture ID :</strong> <span class="mono">${data.id}</span></div>
            <div><strong>Fichier :</strong> ${data.fichier_nom || "‚Äî"}</div>
            <div><strong>Statut :</strong> <span class="mono">${data.statut || "‚Äî"}</span></div>
            <div><strong>Cr√©√© le :</strong> ${data.created_at || "‚Äî"}</div>
          `;

          textContent.textContent = (data.texte_ocr || "").trim() || "‚ö†Ô∏è Aucun texte enregistr√©.";
          textModal.style.display = "flex";
        } catch (e) {
          setMsg("err", "Erreur lecture texte: " + (e?.message || e));
        }
      }

      // Initial render
      render();
    }
  </script>

  <!-- ‚úÖ MODALE : Viewer du texte extrait -->
  <div id="textModal" style="
    display:none; position:fixed; inset:0; background:rgba(0,0,0,.5);
    align-items:center; justify-content:center; padding:18px; z-index:9999;">
    <div style="
      width:min(980px, 95vw); max-height:85vh; background:#fff; border-radius:14px;
      border:1px solid #e5e5e5; overflow:hidden; display:flex; flex-direction:column;">
      <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #eee;">
        <strong>üßæ Texte extrait</strong>
        <div style="display:flex; gap:8px;">
          <button class="btn" id="copyTextBtn">üìã Copier</button>
          <button class="btn" id="closeTextBtn">‚úñ Fermer</button>
        </div>
      </div>
      <div style="padding:12px 14px; overflow:auto;">
        <div class="muted" id="textMeta" style="margin-bottom:10px;"></div>
        <pre id="textContent" style="
          white-space:pre-wrap; word-break:break-word;
          background:#fafafa; border:1px solid #eee; border-radius:12px;
          padding:12px; font-size:13px; line-height:1.35;"></pre>
      </div>
    </div>
  </div>
</body>
</html>
