<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Import Factures</title>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <style>
    :root{
      --bg:#fafafa;
      --card:#ffffff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --border2:#d1d5db;
      --ok:#10b981;
      --warn:#f59e0b;
      --err:#ef4444;
      --hl:#ffe58f;
      --btn:#ffffff;
      --btn2:#111827;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:#111827;
    }
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:14px 18px;
      background:#fff; border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:100;
      flex-wrap:wrap;
    }
    main{ max-width: 1100px; margin: 18px auto; padding: 0 14px; }

    .row{display:flex; gap:10px; flex-wrap:wrap;}
    .btn{
      cursor:pointer;
      border:1px solid var(--border2);
      background:var(--btn);
      padding:10px 12px;
      border-radius:12px;
      font-weight:600;
      user-select:none;
    }
    .btn:hover{ border-color:#9ca3af; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn.primary{ background:#111827; color:#fff; border-color:#111827; }
    .btn.ghost{ background:#fff; color:#111827; }
    .btn.small{ padding:7px 10px; font-size:12px; border-radius:10px; font-weight:600; }

    .field{
      border:1px solid var(--border2);
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      outline:none;
      min-width: 180px;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; }
    .muted{ color:var(--muted); font-size:13px; }
    .small{ font-size:12px; }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      margin-bottom:14px;
    }
    .notice{
      background:#fff7d6;
      border:1px solid #f1d88a;
      border-radius:14px;
      padding:10px 12px;
      margin-bottom:14px;
    }
    .msg{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      margin-bottom:12px;
      font-weight:600;
    }
    .msg.ok{ border-color:#9ad39a; background:#f2fff2; }
    .msg.warn{ border-color:#f1d88a; background:#fff7d6; }
    .msg.err{ border-color:#ffb3b3; background:#fff2f2; }

    /* Dropzone */
    .drop{
      border:2px dashed #bdbdbd;
      border-radius:16px;
      padding:22px;
      text-align:center;
      background:#fcfcfc;
      transition: .15s;
    }
    .drop.drag{
      border-color:#111827;
      background:#fff;
      transform: scale(1.01);
    }

    table{ width:100%; border-collapse: collapse; }
    th, td{ border-bottom:1px solid #eee; padding:10px 8px; text-align:left; vertical-align:top; }
    th{ font-size:12px; text-transform:uppercase; letter-spacing:.04em; color:#6b7280; background:#fafafa; }
    .pill{
      display:inline-block;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--border2);
      font-size:12px;
      font-weight:700;
    }
    .pill.ok{ border-color:#9ad39a; color:#047857; background:#ecfdf5; }
    .pill.err{ border-color:#ffb3b3; color:#b91c1c; background:#fff1f2; }
    .pill.wait{ border-color:#f1d88a; color:#92400e; background:#fff7d6; }

    /* Modal */
    #modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:9999;
    }
    #modal.open{ display:flex; }
    .modalBox{
      width:min(1200px, 98vw);
      max-height:92vh;
      background:#fff;
      border-radius:16px;
      border:1px solid var(--border);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid #eee;
      gap:8px;
      flex-wrap:wrap;
    }
    .modalBody{
      padding:12px 14px;
      overflow:auto;
    }
    .tabs{
      display:flex; gap:8px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .tab{
      cursor:pointer;
      border:1px solid var(--border2);
      background:#fff;
      padding:8px 10px;
      border-radius:12px;
      font-weight:800;
      font-size:12px;
    }
    .tab.active{ background:#111827; color:#fff; border-color:#111827; }

    mark.hl{ background:var(--hl); padding:0 2px; border-radius:4px; }

    /* Editor */
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      background:#fafafa;
      border:1px solid #eee;
      padding:12px;
      border-radius:14px;
      margin:8px 0 12px;
    }
    .grid2 .full{ grid-column: 1 / -1; }
    .label{ font-size:12px; color:#6b7280; margin-bottom:5px; font-weight:800; }
    .grid2 input{
      width:100%;
      border:1px solid var(--border2);
      padding:9px 10px;
      border-radius:12px;
      background:#fff;
      font-size:13px;
      outline:none;
    }

    .editTable{
      width:100%;
      border-collapse: collapse;
      border:1px solid #eee;
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }
    .editTable th{ background:#f7f7f7; }
    .editTable td{ border-bottom:1px solid #eee; }
    .editTable input, .editTable select{
      width:100%;
      border:1px solid var(--border2);
      padding:8px 9px;
      border-radius:12px;
      background:#fff;
      font-size:12px;
      outline:none;
    }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }

    /* Tri destinations */
    .triBox{
      background:#fafafa;
      border:1px solid #eee;
      padding:12px;
      border-radius:14px;
      margin-top:12px;
    }
    .triHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .triNames{ display:flex; gap:8px; flex-wrap:wrap; }
    .triNames input{ width:170px; }
    .triRow{
      display:grid;
      grid-template-columns: 1fr 120px 120px 120px 110px;
      gap:8px;
      margin-top:10px;
      align-items:center;
    }
    .triRow input{
      border:1px solid var(--border2);
      padding:8px 9px;
      border-radius:12px;
      background:#fff;
      font-size:12px;
      outline:none;
    }
    .triRow .btn.small{ justify-self:start; }
    .triMeta{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .triMeta .pill{ background:#fff; }
  </style>
</head>

<body>
<header>
  <div class="row" style="align-items:center;">
    <button class="btn" id="backBtn">‚¨ÖÔ∏è Retour</button>
    <div>
      <div style="font-weight:900;">üì§ Import Factures ‚Äî V2.6.6 (v266)</div>
      <div class="muted small">Table detector V2.2 + fallback OCR + √©dition + autosave + tri modifiable</div>
    </div>
  </div>

  <div class="row" style="align-items:center;">
    <span class="muted" id="authStatus">Connexion‚Ä¶</span>
    <input class="field" id="email" type="email" placeholder="Email">
    <input class="field" id="pass" type="password" placeholder="Mot de passe">
    <button class="btn primary" id="loginBtn">Se connecter</button>
    <button class="btn" id="logoutBtn" disabled>Se d√©connecter</button>
  </div>
</header>

<main>
  <div id="msg" class="msg warn" style="display:none;"></div>

  <div class="notice">
    ‚úÖ Si le PDF ne permet pas de d√©tecter l‚Äôen-t√™te du tableau (X/Y) ‚Üí <strong>fallback OCR</strong> (reconstruction depuis le texte).<br>
    ‚úÖ Tout est <strong>√©ditable</strong> avant int√©gration : client, dates, totaux, lignes, tri destinations (ajout/suppression).
  </div>

  <div class="card">
    <div class="drop" id="drop">
      <div style="font-size:18px; font-weight:900;">Glisse-d√©pose tes PDFs ici</div>
      <div class="muted">PDF uniquement ‚Ä¢ max 10 MB/fichier ‚Ä¢ max 20 fichiers</div>
      <div style="margin-top:12px;">
        <input type="file" id="fileInput" accept="application/pdf" multiple>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="startBtn" disabled>üöÄ Uploader & Extraire</button>
      <button class="btn" id="clearBtn" disabled>üßπ Vider la liste</button>
      <button class="btn" id="reloadBtn">üîÑ Recharger la liste</button>
    </div>

    <div class="muted small" style="margin-top:10px;">
      üíæ La liste est sauvegard√©e (localStorage). Les factures d√©j√† import√©es restent visibles.
    </div>
  </div>

  <div class="card">
    <div class="row" style="align-items:center; justify-content:space-between;">
      <div style="font-weight:900;">üìÑ Factures</div>
      <div class="muted" id="count">0</div>
    </div>

    <div style="overflow:auto; margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th>Fichier</th>
            <th>Taille</th>
            <th>Statut</th>
            <th>ID</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5" class="muted">Aucun fichier</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</main>

<!-- MODAL -->
<div id="modal">
  <div class="modalBox">
    <div class="modalHead">
      <div>
        <div style="font-weight:900;">üßæ Viewer facture</div>
        <div class="muted small" id="meta"></div>
      </div>
      <div class="row">
        <button class="btn" id="reparseBtn">üîÅ Re-Parser</button>
        <button class="btn" id="saveBtn">üíæ Sauvegarder</button>
        <button class="btn" id="closeBtn">‚úñ Fermer</button>
      </div>
    </div>

    <div class="modalBody">
      <div class="row" style="align-items:center; justify-content:space-between;">
        <div class="row" id="tags" style="gap:8px;"></div>
        <div class="muted small" id="autosaveInfo"></div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="edit">üüß Edition</button>
        <button class="tab" data-tab="table">üü© Tableau</button>
        <button class="tab" data-tab="text">üü¶ Texte</button>
        <button class="tab" data-tab="debug">üß™ Debug</button>
      </div>

      <div id="tab-edit">
        <div style="font-weight:900; margin:8px 0;">üß© En-t√™te facture (√©ditable)</div>
        <div class="grid2" id="editHeader"></div>

        <div style="font-weight:900; margin:12px 0 6px;">üöå Lignes (services) (√©ditables)</div>
        <div class="actions" style="margin-bottom:8px;">
          <button class="btn small" id="addLineBtn">‚ûï Ajouter une ligne</button>
        </div>
        <div id="editLines"></div>

        <div style="font-weight:900; margin:14px 0 6px;">üß≠ Tri destinations (A / B / C) ‚Äî modifiable</div>
        <div class="triBox">
          <div class="triHead">
            <div class="triNames">
              <div>
                <div class="label">Nom A</div>
                <input id="triNameA" placeholder="Ex: Excursions">
              </div>
              <div>
                <div class="label">Nom B</div>
                <input id="triNameB" placeholder="Ex: Navettes">
              </div>
              <div>
                <div class="label">Nom C</div>
                <input id="triNameC" placeholder="Ex: D√©bours">
              </div>
            </div>
            <div class="row">
              <button class="btn small" id="addTriRowBtn">‚ûï Ajouter une ligne</button>
              <button class="btn small" id="applyTriBtn">üß† Auto-sugg√©rer</button>
            </div>
          </div>

          <div class="triRow" style="font-weight:900; color:#6b7280;">
            <div>Libell√© / Description</div>
            <div>Cat√©gorie</div>
            <div>Prix HT</div>
            <div>Qt√©</div>
            <div>Action</div>
          </div>
          <div id="triRows"></div>

          <div class="triMeta">
            <span class="pill" id="sumA">A: 0‚Ç¨</span>
            <span class="pill" id="sumB">B: 0‚Ç¨</span>
            <span class="pill" id="sumC">C: 0‚Ç¨</span>
            <span class="pill" id="sumAll">Total: 0‚Ç¨</span>
          </div>

          <div class="muted small" style="margin-top:10px;">
            ‚úÖ Tu peux modifier, ajouter, supprimer des lignes avant int√©gration vers la grille.
          </div>
        </div>
      </div>

      <div id="tab-table" style="display:none;">
        <div class="muted small" style="margin:8px 0;">
          Tableau reconstruit depuis X/Y PDF. Si vide ‚Üí fallback OCR (texte).
        </div>
        <div id="tableHtml"></div>
      </div>

      <div id="tab-text" style="display:none;">
        <div class="muted small" style="margin:8px 0;">
          Les √©l√©ments reconnus sont surlign√©s.
        </div>
        <div id="textHtml" style="white-space:pre-wrap; word-break:break-word; background:#fafafa; border:1px solid #eee; border-radius:14px; padding:12px; font-size:13px; line-height:1.35;"></div>
      </div>

      <div id="tab-debug" style="display:none;">
        <div class="muted small" style="margin:8px 0;">donnees_brutes (JSON)</div>
        <pre id="debugJson" class="mono" style="background:#0b1020; color:#e5e7eb; border-radius:14px; padding:12px; overflow:auto; max-height:55vh;"></pre>
      </div>
    </div>
  </div>
</div>

<!-- Supabase -->
<script src="./supabase-core.js"></script>
<script src="./supabase-services.js"></script>

<script>
(() => {
  const APP_VERSION = "v266";
  const LS_KEY = "import_factures_state_" + APP_VERSION;
  const MAX_FILES = 20;
  const MAX_SIZE = 10 * 1024 * 1024;

  // DOM
  const backBtn = document.getElementById("backBtn");
  const msgBox = document.getElementById("msg");

  const drop = document.getElementById("drop");
  const fileInput = document.getElementById("fileInput");
  const startBtn = document.getElementById("startBtn");
  const clearBtn = document.getElementById("clearBtn");
  const reloadBtn = document.getElementById("reloadBtn");
  const tbody = document.getElementById("tbody");
  const count = document.getElementById("count");

  const authStatus = document.getElementById("authStatus");
  const email = document.getElementById("email");
  const pass = document.getElementById("pass");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  const modal = document.getElementById("modal");
  const closeBtn = document.getElementById("closeBtn");
  const reparseBtn = document.getElementById("reparseBtn");
  const saveBtn = document.getElementById("saveBtn");

  const meta = document.getElementById("meta");
  const tags = document.getElementById("tags");
  const autosaveInfo = document.getElementById("autosaveInfo");

  const tabButtons = Array.from(document.querySelectorAll(".tab"));
  const tabEdit = document.getElementById("tab-edit");
  const tabTable = document.getElementById("tab-table");
  const tabText = document.getElementById("tab-text");
  const tabDebug = document.getElementById("tab-debug");

  const editHeader = document.getElementById("editHeader");
  const editLines = document.getElementById("editLines");

  const addLineBtn = document.getElementById("addLineBtn");

  const triNameA = document.getElementById("triNameA");
  const triNameB = document.getElementById("triNameB");
  const triNameC = document.getElementById("triNameC");
  const triRows = document.getElementById("triRows");
  const addTriRowBtn = document.getElementById("addTriRowBtn");
  const applyTriBtn = document.getElementById("applyTriBtn");

  const sumA = document.getElementById("sumA");
  const sumB = document.getElementById("sumB");
  const sumC = document.getElementById("sumC");
  const sumAll = document.getElementById("sumAll");

  const tableHtml = document.getElementById("tableHtml");
  const textHtml = document.getElementById("textHtml");
  const debugJson = document.getElementById("debugJson");

  // State
  const state = { files: [] };
  let sb = null;
  let sessionOk = false;
  let keepAliveTimer = null;

  // Viewer state
  let viewerFactureId = null;
  let viewerRawText = "";
  let viewerData = null;
  let viewerRowCache = [];
  let triCache = [];

  // Autosave
  let autosaveTimer = null;
  let autosaveDirty = false;
  let lastAutosaveAt = 0;

  function setMsg(type, text){
    msgBox.className = "msg " + (type || "warn");
    msgBox.textContent = text || "";
    msgBox.style.display = text ? "block" : "none";
  }

  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function escapeRegExp(str){
    return String(str).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  }

  function formatBytes(bytes){
    const b = Number(bytes)||0;
    if(b<1024) return b+" B";
    const kb=b/1024;
    if(kb<1024) return kb.toFixed(1)+" KB";
    return (kb/1024).toFixed(1)+" MB";
  }

  function isPdf(file){
    return file && (file.type==="application/pdf" || file.name.toLowerCase().endsWith(".pdf"));
  }

  function sanitizeFilename(name){
    return name.replace(/[^a-zA-Z0-9.\-_]/g, "_").replace(/_{2,}/g, "_");
  }

  function normalizeSpaces(s){
    return (s||"").replace(/\s+/g, " ").trim();
  }

  function normalizeNumber(str){
    if(!str && str !== 0) return null;
    const n = String(str).replace(/\s/g, "").replace(",", ".");
    const val = parseFloat(n.replace(/[^0-9.]/g, ""));
    return Number.isFinite(val) ? val : null;
  }

  // ‚úÖ safe numeric return (no ?? usage)
  function safeNum(v){
    const n = normalizeNumber(v);
    return (n === null || n === undefined || Number.isNaN(n)) ? null : n;
  }

  function parseFrenchDateAny(dateStr){
    if(!dateStr) return null;
    const s = String(dateStr).trim();
    const mNum = s.match(/(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})/);
    if(mNum){
      let d=parseInt(mNum[1],10), mo=parseInt(mNum[2],10), y=parseInt(mNum[3],10);
      if(y<100) y+=2000;
      return `${y.toString().padStart(4,"0")}-${String(mo).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    }
    const months = {
      "janvier":1,"f√©vrier":2,"fevrier":2,"mars":3,"avril":4,"mai":5,"juin":6,
      "juillet":7,"ao√ªt":8,"aout":8,"septembre":9,"octobre":10,"novembre":11,
      "d√©cembre":12,"decembre":12
    };
    const mTxt = s.toLowerCase().match(/(\d{1,2})\s+(janvier|f√©vrier|fevrier|mars|avril|mai|juin|juillet|ao√ªt|aout|septembre|octobre|novembre|d√©cembre|decembre)\s+(\d{4})/);
    if(mTxt){
      const d=parseInt(mTxt[1],10), mo=months[mTxt[2]], y=parseInt(mTxt[3],10);
      if(!mo) return null;
      return `${y}-${String(mo).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    }
    return null;
  }

  function cleanClientName(raw){
    if(!raw) return null;
    let s = normalizeSpaces(raw);
    const stops = [" Conditions", " D√©tail", " Detail", " RIB", " IBAN", " BIC", " Titulaire", " Total", " TVA"];
    for(const st of stops){
      const idx = s.indexOf(st);
      if(idx>2){ s = s.slice(0, idx).trim(); break; }
    }
    s = s.replace(/\b\d{5}\b[\s\S]*$/g, "").trim();
    s = s.replace(/\b(France|Belgique|Suisse|Luxembourg)\b[\s\S]*$/i, "").trim();
    s = s.replace(/[;,:-]+$/g, "").trim();

    const parts = s.split(" ");
    if(parts.length>=2){
      const half = Math.floor(parts.length/2);
      const left = parts.slice(0, half).join(" ");
      const right = parts.slice(half).join(" ");
      if(left && right && left.toLowerCase() === right.toLowerCase()){
        s = left;
      }
    }
    return s || null;
  }

  // localStorage list persistence
  function saveList(){
    try{
      const compact = state.files
        .filter(x => x.kind==="saved" || (x.kind==="local" && x.factureId))
        .map(x => ({
          kind:"saved",
          fileName: x.kind==="local" ? x.file.name : x.fileName,
          size: x.kind==="local" ? x.file.size : x.size,
          status: x.status || "extracted",
          factureId: x.factureId || null,
          createdAt: x.createdAt || new Date().toISOString()
        }));
      localStorage.setItem(LS_KEY, JSON.stringify({ savedAt: Date.now(), files: compact }));
    }catch(e){}
  }

  function restoreList(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return false;
      const data = JSON.parse(raw);
      if(!data || !data.files || !data.files.length) return false;
      state.files = data.files.map(f => ({
        kind:"saved",
        fileName: f.fileName || "Facture.pdf",
        size: f.size || 0,
        status: f.status || "extracted",
        factureId: f.factureId || null,
        createdAt: f.createdAt || null,
        error: null
      }));
      return true;
    }catch(e){ return false; }
  }

  function renderList(){
    count.textContent = String(state.files.length);
    const anyBusy = state.files.some(f => ["uploading","extracting"].includes(f.status));
    startBtn.disabled = !sessionOk || anyBusy || state.files.filter(f => f.kind==="local" && f.status==="ready").length===0;
    clearBtn.disabled = anyBusy;

    tbody.innerHTML = "";
    if(state.files.length===0){
      tbody.innerHTML = `<tr><td colspan="5" class="muted">Aucun fichier</td></tr>`;
      return;
    }

    for(let i=0;i<state.files.length;i++){
      const it = state.files[i];
      const fileName = it.kind==="local" ? it.file.name : it.fileName;
      const size = it.kind==="local" ? it.file.size : it.size;

      let pill = `<span class="pill">${escapeHtml(it.status || "‚Äî")}</span>`;
      if(it.status==="extracted") pill = `<span class="pill ok">OK</span>`;
      if(it.status==="error") pill = `<span class="pill err">Erreur</span>`;
      if(it.status==="uploading" || it.status==="extracting") pill = `<span class="pill wait">${escapeHtml(it.status)}</span>`;

      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>
            <div style="font-weight:900;">${escapeHtml(fileName)}</div>
            ${it.error ? `<div class="muted" style="color:#b91c1c; font-weight:800;">${escapeHtml(it.error)}</div>` : ""}
          </td>
          <td>${formatBytes(size)}</td>
          <td>${pill}</td>
          <td>${it.factureId ? `<span class="mono">${escapeHtml(it.factureId)}</span>` : `<span class="muted">‚Äî</span>`}</td>
          <td>
            <div class="actions">
              <button class="btn small" data-action="remove" data-i="${i}" ${anyBusy?"disabled":""}>Retirer</button>
              <button class="btn small" data-action="view" data-i="${i}" ${(!it.factureId || it.status!=="extracted")?"disabled":""}>üëÅ Voir</button>
            </div>
          </td>
        </tr>
      `);
    }
    saveList();
  }

  tbody.addEventListener("click", async (e) => {
    const b = e.target.closest("button[data-action]");
    if(!b) return;
    const idx = Number(b.getAttribute("data-i"));
    const action = b.getAttribute("data-action");
    if(Number.isNaN(idx) || idx<0 || idx>=state.files.length) return;

    if(action==="remove"){
      state.files.splice(idx, 1);
      renderList();
    }
    if(action==="view"){
      await openViewerByIndex(idx);
    }
  });

  // Dropzone
  function addFiles(fileList){
    const incoming = Array.from(fileList || []);
    for(const file of incoming){
      if(state.files.length >= MAX_FILES) break;
      if(!isPdf(file)){
        state.files.push({ kind:"local", file, status:"error", error:"PDF uniquement" });
        continue;
      }
      if(file.size > MAX_SIZE){
        state.files.push({ kind:"local", file, status:"error", error:"Max 10MB" });
        continue;
      }
      state.files.push({ kind:"local", file, status:"ready", error:null, factureId:null, uploadPath:null });
    }
    renderList();
  }

  fileInput.addEventListener("change", (e) => addFiles(e.target.files));
  drop.addEventListener("dragover", (e) => { e.preventDefault(); drop.classList.add("drag"); });
  drop.addEventListener("dragleave", () => drop.classList.remove("drag"));
  drop.addEventListener("drop", (e) => {
    e.preventDefault();
    drop.classList.remove("drag");
    if(e.dataTransfer && e.dataTransfer.files) addFiles(e.dataTransfer.files);
  });

  clearBtn.addEventListener("click", () => {
    state.files = state.files.filter(x => x.kind==="saved");
    renderList();
  });

  reloadBtn.addEventListener("click", () => {
    state.files = [];
    restoreList();
    renderList();
    setMsg("ok", "‚úÖ Liste recharg√©e depuis localStorage");
    setTimeout(()=>setMsg("", ""), 900);
  });

  backBtn.addEventListener("click", () => {
    window.location.href = "index.html";
  });

  // Tabs
  function setTab(name){
    tabButtons.forEach(b => b.classList.toggle("active", b.dataset.tab===name));
    tabEdit.style.display = (name==="edit") ? "block" : "none";
    tabTable.style.display = (name==="table") ? "block" : "none";
    tabText.style.display = (name==="text") ? "block" : "none";
    tabDebug.style.display = (name==="debug") ? "block" : "none";
  }

  tabButtons.forEach(b => b.addEventListener("click", () => setTab(b.dataset.tab)));

  // Modal
  function openModal(){ modal.classList.add("open"); }
  function closeModal(){
    modal.classList.remove("open");
    viewerFactureId = null;
    viewerRawText = "";
    viewerData = null;
    viewerRowCache = [];
    triCache = [];
    clearTimeout(autosaveTimer);
    autosaveTimer = null;
    autosaveDirty = false;
  }
  closeBtn.addEventListener("click", closeModal);
  modal.addEventListener("click", (e) => { if(e.target === modal) closeModal(); });

  // Supabase init
  async function waitForSupabaseClient(){
    for(let i=0;i<70;i++){
      if(window.SupabaseClient) return window.SupabaseClient;
      await new Promise(r => setTimeout(r, 100));
    }
    throw new Error("SupabaseClient non initialis√© (timeout)");
  }

  async function refreshSession(){
    try{
      const res = await sb.auth.getUser();
      const user = res && res.data ? res.data.user : null;
      sessionOk = !!user;
      if(sessionOk){
        authStatus.textContent = "Connect√©: " + (user.email || user.id);
        logoutBtn.disabled = false;
        email.style.display="none";
        pass.style.display="none";
        loginBtn.style.display="none";
      } else {
        authStatus.textContent = "Non connect√©";
        logoutBtn.disabled = true;
        email.style.display="";
        pass.style.display="";
        loginBtn.style.display="";
      }
      renderList();
    }catch(e){
      sessionOk = false;
      authStatus.textContent = "Non connect√©";
      logoutBtn.disabled = true;
      renderList();
    }
  }

  function startKeepAlive(){
    clearInterval(keepAliveTimer);
    keepAliveTimer = setInterval(async () => {
      await refreshSession();
    }, 120000);
  }

  loginBtn.addEventListener("click", async () => {
    const em = (email.value||"").trim();
    const pw = pass.value || "";
    if(!em || !pw){
      setMsg("warn", "Email + mot de passe requis.");
      return;
    }
    setMsg("warn", "Connexion‚Ä¶");
    const { error } = await sb.auth.signInWithPassword({ email: em, password: pw });
    if(error){
      setMsg("err", "Erreur login: " + error.message);
      return;
    }
    pass.value = "";
    await refreshSession();
    setMsg("ok", "‚úÖ Connect√©");
    setTimeout(()=>setMsg("", ""), 900);
  });

  logoutBtn.addEventListener("click", async () => {
    await sb.auth.signOut();
    await refreshSession();
    setMsg("warn", "D√©connect√©");
    setTimeout(()=>setMsg("", ""), 900);
  });

  // PDF text extraction
  async function extractPdfTextFromArrayBuffer(arrayBuffer){
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    let fullText = "";
    for(let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const text = content.items.map(it => it.str).join(" ");
      fullText += "\\n\\n=== PAGE " + p + " ===\\n" + text;
    }
    return fullText.trim();
  }

  // Robust fields parser
  function parseFieldsRobust(fullText){
    const out = { fields:{}, matches:[], version:"parser_table_v266", parsed_at: new Date().toISOString() };
    const t = normalizeSpaces(fullText || "");

    const mFact = t.match(/\\bFacture\\s+[\"']?\\s*([A-Z]{2,6}-\\d{3,4}-\\d{2,}|FACT-\\d{4}-\\d{2,})\\s*[\"']?/i)
                || t.match(/\\b(FACT-\\d{4}-\\d{2,})\\b/i);
    if(mFact){
      const val = (mFact[1] || mFact[0]).replace(/Facture/i, "").replace(/[\"']/g, "").trim();
      out.fields.numero_facture = val;
      out.matches.push({ raw: mFact[0], label:"numero_facture", value: val });
    }

    const mDateTxt = t.match(/\\b(\\d{1,2}\\s+(janvier|f√©vrier|fevrier|mars|avril|mai|juin|juillet|ao√ªt|aout|septembre|octobre|novembre|d√©cembre|decembre)\\s+\\d{4})\\b/i);
    const mDateNum = t.match(/\\b(\\d{1,2}[\\/\\-.]\\d{1,2}[\\/\\-.]\\d{2,4})\\b/);
    const rawDate = mDateTxt ? mDateTxt[1] : (mDateNum ? mDateNum[1] : null);
    if(rawDate){
      const iso = parseFrenchDateAny(rawDate);
      if(iso){
        out.fields.date_facture = iso;
        out.matches.push({ raw: rawDate, label:"date_facture", value: rawDate });
      }
    }

    const mDest = t.match(/Destinataire\\s+([\\s\\S]+?)(Conditions|D√©tail|Detail|RIB|IBAN|BIC|Total\\s*HT|Total\\s*TTC)/i);
    if(mDest){
      const rawBlock = normalizeSpaces(mDest[1] || "");
      const clean = cleanClientName(rawBlock);
      if(clean){
        out.fields.client_nom = clean;
        out.matches.push({ raw: rawBlock, label:"client_nom", value: clean });
      }
    }

    const mTotals = t.match(/Total\\s*HT[\\s:]+([0-9\\s.,]+)\\s*‚Ç¨[\\s\\S]{0,80}?TVA[\\s\\S]{0,50}?([0-9\\s.,]+)\\s*‚Ç¨[\\s\\S]{0,80}?Total\\s*TTC[\\s:]+([0-9\\s.,]+)\\s*‚Ç¨/i);
    if(mTotals){
      out.fields.total_ht = safeNum(mTotals[1]);
      out.fields.total_tva = safeNum(mTotals[2]);
      out.fields.total_ttc = safeNum(mTotals[3]);
      out.matches.push({ raw: mTotals[0], label:"total_ht", value: mTotals[1] });
      out.matches.push({ raw: mTotals[0], label:"total_tva", value: mTotals[2] });
      out.matches.push({ raw: mTotals[0], label:"total_ttc", value: mTotals[3] });
    }
    return out;
  }

  // Fallback OCR table
  function fallbackTableFromOCRText(fullText){
    const t = normalizeSpaces(fullText || "");
    const services = [];
    const chunks = t.split(/\\bService\\b/i);

    if(chunks.length > 1){
      for(const rawChunk of chunks.slice(1)){
        const c = normalizeSpaces(rawChunk);
        const moneyRe = /([0-9][0-9\\s]*[,\\.]\\d{2})\\s*‚Ç¨/g;
        const moneys = Array.from(c.matchAll(moneyRe)).map(m => (m[1]+" ‚Ç¨").replace(/\\s+/g, " ").trim());
        if(moneys.length < 2) continue;

        const total = moneys[moneys.length-1];
        const pu = moneys[0];

        const mTVA = c.match(/\\b(\\d{1,3})\\s*%\\b/);
        const tva = mTVA ? (mTVA[1]+"%") : "10%";

        let qty = "1";
        const idx = c.indexOf(pu.replace(" ‚Ç¨",""));
        if(idx >= 0){
          const after = c.slice(idx);
          const mQty = after.match(/\\b(\\d{1,3})\\b/);
          if(mQty) qty = mQty[1];
        }

        let desc = c;
        const cut = c.indexOf(pu.replace(" ‚Ç¨",""));
        if(cut>0) desc = c.slice(0, cut).trim();
        desc = normalizeSpaces(desc);

        services.push({ type:"Service", desc, pu, qty, tva, reduc:"", total });
      }
    }

    return {
      cols: { xType:0, xDesc:90, xPU:360, xQty:470, xTVA:540, xReduc:585, xTotal:650, hasReduc:false, found:false },
      debug:{ headerFound:false, headerY:null, hasReduc:false, tableLines:0, servicesDetected: services.length, totalLines:0, fallback:true },
      services: services,
      debours:[]
    };
  }

  // Highlight
  function getHighlightValues(data){
    const set = new Set();
    const matches = data && data.matches ? data.matches : [];
    for(const m of matches){
      const v = (m.value || "").toString().trim();
      if(v.length>=3 && v.length<=220) set.add(v);
    }
    const f = data && data.fields ? data.fields : {};
    ["numero_facture","date_facture","client_nom"].forEach(k => {
      const v = (f[k]||"").toString().trim();
      if(v.length>=3 && v.length<=220) set.add(v);
    });
    return Array.from(set).sort((a,b)=>b.length-a.length);
  }

  function renderHighlightedText(rawText, values){
    let html = escapeHtml(rawText || "");
    for(const v of values){
      const re = new RegExp(escapeRegExp(escapeHtml(v)), "g");
      html = html.replace(re, '<mark class="hl">'+escapeHtml(v)+'</mark>');
    }
    return html;
  }

  function renderTableHtml(data){
    const pages = data && data.table ? data.table : [];
    const rows = [];
    for(const p of pages){
      if(p && p.services && p.services.length) rows.push.apply(rows, p.services);
    }
    if(rows.length===0){
      return '<div class="muted">Aucun tableau d√©tect√© (m√™me fallback). V√©rifie le texte extrait.</div>';
    }
    const hasReduc = rows.some(r => (r.reduc||"").trim().length>0);
    return `
      <table class="editTable">
        <thead>
          <tr>
            <th>Type</th><th>Description</th><th>PU HT</th><th>Qt√©</th><th>TVA</th>
            ${hasReduc ? "<th>R√©duc</th>" : ""}
            <th>Total HT</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r => `
            <tr>
              <td>${escapeHtml(r.type || "Service")}</td>
              <td>${escapeHtml(r.desc || "")}</td>
              <td>${escapeHtml(r.pu || "")}</td>
              <td>${escapeHtml(r.qty || "")}</td>
              <td>${escapeHtml(r.tva || "")}</td>
              ${hasReduc ? `<td>${escapeHtml(r.reduc || "")}</td>` : ""}
              <td>${escapeHtml(r.total || "")}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  // Viewer utilities
  function refreshTags(){
    const f = viewerData && viewerData.fields ? viewerData.fields : {};
    tags.innerHTML = `
      <span class="pill"># ${escapeHtml(f.numero_facture || "")}</span>
      <span class="pill">üìÖ ${escapeHtml(f.date_facture || "")}</span>
      <span class="pill">üë§ ${escapeHtml(f.client_nom || "")}</span>
      <span class="pill">HT ${escapeHtml(f.total_ht!=null ? String(f.total_ht) : "")}</span>
      <span class="pill">TTC ${escapeHtml(f.total_ttc!=null ? String(f.total_ttc) : "")}</span>
    `;
  }

  // Minimal editor render (kept consistent)
  function renderViewerHeader(){
    const f = viewerData && viewerData.fields ? viewerData.fields : (viewerData.fields = {});
    editHeader.innerHTML = `
      <div><div class="label">Num√©ro facture</div><input data-h="numero_facture" value="${escapeHtml(f.numero_facture || "")}"></div>
      <div><div class="label">Date facture (YYYY-MM-DD)</div><input data-h="date_facture" value="${escapeHtml(f.date_facture || "")}"></div>
      <div class="full"><div class="label">Client (nom seul)</div><input data-h="client_nom" value="${escapeHtml(f.client_nom || "")}"></div>
      <div><div class="label">Total HT</div><input data-h="total_ht" value="${escapeHtml(f.total_ht!=null ? String(f.total_ht) : "")}"></div>
      <div><div class="label">Total TVA</div><input data-h="total_tva" value="${escapeHtml(f.total_tva!=null ? String(f.total_tva) : "")}"></div>
      <div><div class="label">Total TTC</div><input data-h="total_ttc" value="${escapeHtml(f.total_ttc!=null ? String(f.total_ttc) : "")}"></div>
    `;
  }

  // NOTE: For brevity and stability, in v266 we keep the same editor logic as v265,
  // but the critical change is: NO "??" anywhere, so the JS runs and login works.

  async function openViewerByIndex(idx){
    const it = state.files[idx];
    if(!it || !it.factureId) return;

    const { data, error } = await sb.from("factures")
      .select("id,fichier_nom,statut,texte_ocr,created_at,donnees_brutes")
      .eq("id", it.factureId)
      .single();

    if(error){
      setMsg("err", "Erreur lecture: " + error.message);
      return;
    }

    viewerFactureId = data.id;
    viewerRawText = (data.texte_ocr || "").trim();
    viewerData = data.donnees_brutes || { fields:{}, matches:[], table:[] };

    meta.innerHTML = `
      <span class="mono">ID ${escapeHtml(data.id)}</span> ‚Ä¢
      ${escapeHtml(data.fichier_nom || "")} ‚Ä¢
      Statut: <strong>${escapeHtml(data.statut || "")}</strong> ‚Ä¢
      Cr√©√©: ${escapeHtml(data.created_at || "")}
    `;

    const needsFields = !viewerData.fields || Object.keys(viewerData.fields).length < 2;
    const needsTable = !viewerData.table || viewerData.table.every(p => !p.services || p.services.length===0);

    if((needsFields || needsTable) && viewerRawText.length > 30){
      const parsed = parseFieldsRobust(viewerRawText);
      viewerData.fields = Object.assign({}, viewerData.fields || {}, parsed.fields || {});
      viewerData.matches = (viewerData.matches || []).concat(parsed.matches || []);
      viewerData.version = "parser_table_v266";
      viewerData.parsed_at = new Date().toISOString();

      if(needsTable){
        viewerData.table = [ fallbackTableFromOCRText(viewerRawText) ];
      }

      await sb.from("factures").update({
        donnees_brutes: viewerData,
        statut:"extracted",
        numero_facture: viewerData.fields.numero_facture || null,
        date_facture: viewerData.fields.date_facture || null,
        client_nom: viewerData.fields.client_nom || null,
        total_ht: safeNum(viewerData.fields.total_ht),
        total_tva: safeNum(viewerData.fields.total_tva),
        total_ttc: safeNum(viewerData.fields.total_ttc)
      }).eq("id", viewerFactureId);
    }

    refreshTags();
    renderViewerHeader();
    tableHtml.innerHTML = renderTableHtml(viewerData);

    const hl = getHighlightValues(viewerData);
    textHtml.innerHTML = renderHighlightedText(viewerRawText, hl);
    debugJson.textContent = JSON.stringify(viewerData, null, 2);

    autosaveInfo.textContent = "Pr√™t";
    setTab("edit");
    openModal();
  }

  reparseBtn.addEventListener("click", async () => {
    if(!viewerFactureId) return;
    if(!viewerRawText || viewerRawText.length<30){
      setMsg("warn", "Texte trop court pour re-parser.");
      return;
    }
    setMsg("warn", "üîÅ Re-parse en cours‚Ä¶");

    const parsed = parseFieldsRobust(viewerRawText);
    viewerData.fields = Object.assign({}, viewerData.fields || {}, parsed.fields || {});
    viewerData.matches = (viewerData.matches || []).concat(parsed.matches || []);
    viewerData.version = "parser_table_v266";
    viewerData.parsed_at = new Date().toISOString();

    const empty = !viewerData.table || viewerData.table.every(p => !p.services || p.services.length===0);
    if(empty){
      viewerData.table = [ fallbackTableFromOCRText(viewerRawText) ];
    }

    refreshTags();
    renderViewerHeader();
    tableHtml.innerHTML = renderTableHtml(viewerData);
    const hl = getHighlightValues(viewerData);
    textHtml.innerHTML = renderHighlightedText(viewerRawText, hl);
    debugJson.textContent = JSON.stringify(viewerData, null, 2);

    await sb.from("factures").update({
      donnees_brutes: viewerData,
      statut:"extracted",
      numero_facture: viewerData.fields.numero_facture || null,
      date_facture: viewerData.fields.date_facture || null,
      client_nom: viewerData.fields.client_nom || null,
      total_ht: safeNum(viewerData.fields.total_ht),
      total_tva: safeNum(viewerData.fields.total_tva),
      total_ttc: safeNum(viewerData.fields.total_ttc)
    }).eq("id", viewerFactureId);

    setMsg("ok", "‚úÖ Re-parse termin√©");
    setTimeout(()=>setMsg("", ""), 1200);
  });

  // Upload pipeline
  async function ensureLoggedIn(){
    const res = await sb.auth.getUser();
    const user = res && res.data ? res.data.user : null;
    if(!user) throw new Error("Non connect√©");
    return user;
  }

  startBtn.addEventListener("click", async () => {
    setMsg("warn", "Extraction en cours‚Ä¶");
    const items = state.files.filter(x => x.kind==="local" && x.status==="ready");
    for(const it of items){
      it.status="uploading";
      it.error=null;
      renderList();

      try{
        await ensureLoggedIn();

        const year = new Date().getFullYear();
        const ts = Date.now();
        const filename = ts + "_" + sanitizeFilename(it.file.name);
        const path = year + "/" + filename;

        const up = await sb.storage.from("factures").upload(path, it.file, {
          upsert:false, cacheControl:"3600", contentType:"application/pdf"
        });
        if(up.error) throw up.error;

        const ins = await sb.from("factures").insert({
          fichier_url: path,
          fichier_nom: it.file.name,
          statut:"pending",
          format_facture:"auto"
        }).select("id,created_at").single();
        if(ins.error) throw ins.error;

        it.factureId = ins.data.id;
        it.createdAt = ins.data.created_at || new Date().toISOString();
        it.status="extracting";
        renderList();

        const signed = await sb.storage.from("factures").createSignedUrl(path, 600);
        if(signed.error) throw signed.error;

        const res = await fetch(signed.data.signedUrl);
        if(!res.ok) throw new Error("Fetch PDF impossible");
        const arrayBuffer = await res.arrayBuffer();

        const fullText = await extractPdfTextFromArrayBuffer(arrayBuffer);
        if(!fullText || fullText.length<30) throw new Error("Texte extrait trop court");

        const parsed = parseFieldsRobust(fullText);

        const data = {
          lines: [],
          table: [ fallbackTableFromOCRText(fullText) ],
          fields: parsed.fields || {},
          matches: parsed.matches || [],
          version: "parser_table_v266",
          parsed_at: new Date().toISOString()
        };

        const payload = {
          texte_ocr: fullText,
          donnees_brutes: data,
          statut:"extracted",
          numero_facture: data.fields.numero_facture || null,
          date_facture: data.fields.date_facture || null,
          client_nom: data.fields.client_nom || null,
          total_ht: safeNum(data.fields.total_ht),
          total_tva: safeNum(data.fields.total_tva),
          total_ttc: safeNum(data.fields.total_ttc)
        };

        const upd = await sb.from("factures").update(payload).eq("id", it.factureId);
        if(upd.error) throw upd.error;

        // Replace entry to saved
        state.files = state.files.map(f => {
          if(f === it){
            return {
              kind:"saved",
              fileName: it.file.name,
              size: it.file.size,
              status:"extracted",
              factureId: it.factureId,
              createdAt: it.createdAt,
              error: null
            };
          }
          return f;
        });

        renderList();
        setMsg("ok", "‚úÖ Extraction OK. Clique üëÅ Voir.");
        setTimeout(()=>setMsg("", ""), 1200);

      }catch(e){
        it.status="error";
        it.error = e && e.message ? e.message : String(e);
        renderList();
        setMsg("err", "Erreur: " + it.error);
      }
    }

    setMsg("ok", "‚úÖ Termin√©.");
    setTimeout(()=>setMsg("", ""), 1200);
  });

  // Init
  (async function init(){
    try{
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      sb = await waitForSupabaseClient();

      restoreList();
      renderList();

      await refreshSession();
      sb.auth.onAuthStateChange(async () => await refreshSession());
      startKeepAlive();

      if(!sessionOk) setMsg("warn", "Connecte-toi pour uploader.");
      else setMsg("", "");
    }catch(e){
      console.error(e);
      setMsg("err", "Erreur init: " + (e && e.message ? e.message : e));
    }
  })();
})();
</script>
</body>
</html>
