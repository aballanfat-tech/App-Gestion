<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Import Factures</title>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#fafafa; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 18px; background:#fff; border-bottom:1px solid #e5e5e5; position:sticky; top:0; z-index:100; flex-wrap:wrap; }
    .btn { cursor:pointer; border:1px solid #ddd; background:#fff; padding:10px 12px; border-radius:10px; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    main { max-width: 980px; margin: 18px auto; padding: 0 14px; }
    .card { background:#fff; border:1px solid #e5e5e5; border-radius:14px; padding:14px; margin-bottom:14px; }
    .drop { border:2px dashed #bbb; border-radius:14px; padding:22px; text-align:center; background:#fcfcfc; }
    .drop.drag { border-color:#333; background:#fff; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #eee; padding:10px 8px; text-align:left; font-size:14px; vertical-align:top; }
    th { font-size:12px; text-transform:uppercase; letter-spacing:.04em; color:#666; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #ddd; font-size:12px; }
    .ok { border-color:#9ad39a; }
    .err { border-color:#ffb3b3; }
    .muted { color:#666; font-size:13px; }
    .row-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; }
    .notice { background:#fff7d6; border:1px solid #f1d88a; padding:10px 12px; border-radius:12px; margin-bottom:14px; }
    .small { font-size:12px; }
    input[type="file"] { max-width: 100%; }
    .field { border:1px solid #ddd; border-radius:10px; padding:10px 12px; background:#fff; }
    .authBox { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .msg { padding:10px 12px; border-radius:12px; border:1px solid #e5e5e5; background:#fff; }
    .msg.ok { border-color:#9ad39a; background:#f2fff2; }
    .msg.err { border-color:#ffb3b3; background:#fff2f2; }
    .msg.warn { border-color:#f1d88a; background:#fff7d6; }

    mark.hl { background:#ffe58f; padding:0 2px; border-radius:4px; }
    .hlBox { display:flex; gap:10px; flex-wrap:wrap; padding:10px 12px; border:1px solid #eee; border-radius:12px; background:#fafafa; margin:10px 0; }
    .hlTag { border:1px solid #ddd; border-radius:999px; padding:4px 8px; font-size:12px; background:#fff; }

    #textModal { display:none; pointer-events:none; z-index: 9999; }
    #textModal.open { display:flex !important; pointer-events:auto; }

    .tablePdf {
      width:100%;
      border-collapse: collapse;
      font-size:13px;
      background:#fff;
      border:1px solid #eee;
      border-radius:12px;
      overflow:hidden;
    }
    .tablePdf th, .tablePdf td {
      border-bottom:1px solid #eee;
      padding:8px 10px;
      vertical-align:top;
      white-space:nowrap;
    }
    .tablePdf td.desc { white-space:normal; min-width:420px; }
    .tablePdf th { background:#f7f7f7; font-size:12px; text-transform:uppercase; letter-spacing:.03em; }
    .rowDebours td { background:#fff7d6; font-weight:600; }

    .btnSmall {
      border:1px solid #ddd;
      background:#fff;
      padding:6px 8px;
      border-radius:10px;
      cursor:pointer;
      font-size:12px;
    }
    .btnSmall:disabled { opacity:.5; cursor:not-allowed; }

    /* EDIT ZONE */
    .editGrid {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      padding:12px;
      border:1px solid #eee;
      border-radius:12px;
      background:#fafafa;
      margin-bottom:12px;
    }
    .editGrid .label { font-size:12px; color:#666; margin-bottom:4px; }
    .editGrid input {
      width:100%;
      border:1px solid #ddd;
      border-radius:10px;
      padding:8px 10px;
      font-size:13px;
      background:#fff;
    }
    .editFull { grid-column: 1 / -1; }

    .editTable {
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border:1px solid #eee;
      border-radius:12px;
      overflow:hidden;
      font-size:13px;
    }
    .editTable th, .editTable td { border-bottom:1px solid #eee; padding:8px 10px; vertical-align:top; }
    .editTable th { background:#f7f7f7; font-size:12px; text-transform:uppercase; letter-spacing:.03em; color:#666; }
    .editTable input, .editTable select {
      width:100%;
      border:1px solid #ddd;
      border-radius:10px;
      padding:7px 8px;
      font-size:12px;
      background:#fff;
    }
    .editRowActions { display:flex; gap:6px; }
    .sectionTitle { font-weight:800; margin: 12px 0 8px; }

    /* TRI rows */
    .triBox {
      margin-top:10px;
      padding:12px;
      border:1px solid #eee;
      border-radius:12px;
      background:#fafafa;
    }
    .triHead {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .triNames { display:flex; gap:8px; flex-wrap:wrap; }
    .triNames input {
      width:180px;
      border:1px solid #ddd;
      border-radius:10px;
      padding:7px 8px;
      font-size:12px;
      background:#fff;
    }
    .triPrices { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .triPrices input { width:110px; }
    .triSum { font-size:12px; color:#666; }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>

<body>
<header>
  <div style="display:flex; align-items:center; gap:10px;">
    <button class="btn" id="backBtn">‚¨ÖÔ∏è Retour</button>
    <strong>üì§ Import Factures (V2.6 ‚Äì Edition compl√®te + Tri lignes)</strong>
  </div>

  <div class="authBox">
    <span class="muted" id="authStatus">Connexion‚Ä¶</span>
    <input class="field" id="emailInput" type="email" placeholder="Email" style="min-width:220px;">
    <input class="field" id="passInput" type="password" placeholder="Mot de passe" style="min-width:160px;">
    <button class="btn" id="loginBtn">Se connecter</button>
    <button class="btn" id="logoutBtn" disabled>Se d√©connecter</button>
  </div>
</header>

<main>
  <div class="notice">
    <div><strong>V2.6 :</strong> Edition compl√®te des donn√©es extraites + Tri en lignes (A/B/C) avec ajout/suppression.</div>
    <div class="muted small">‚úÖ Autosave partout ‚Ä¢ ‚úÖ Restore liste ‚Ä¢ ‚úÖ Keepalive session</div>
  </div>

  <div id="globalMsg" class="msg warn" style="display:none; margin-bottom:14px;"></div>

  <div class="card">
    <div class="drop" id="dropZone">
      <div style="font-size:18px; margin-bottom:6px;">Glisse-d√©pose tes PDFs ici</div>
      <div class="muted">PDF uniquement ‚Ä¢ max 10 MB/fichier ‚Ä¢ max 20 fichiers</div>
      <div style="margin-top:12px;">
        <input type="file" id="fileInput" accept="application/pdf" multiple />
      </div>
    </div>
    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" id="startUploadBtn" disabled>üöÄ Uploader & Traiter</button>
      <button class="btn" id="clearBtn" disabled>üßπ Vider la liste</button>
    </div>
    <div class="muted small" style="margin-top:10px;">
      üí° La liste des factures d√©j√† import√©es est restaur√©e automatiquement (localStorage).
    </div>
  </div>

  <div class="card">
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <strong>üìÑ Fichiers / Factures</strong>
      <span class="muted" id="selectedCount">0</span>
    </div>

    <div style="overflow:auto; margin-top:10px;">
      <table>
        <thead>
        <tr>
          <th>Fichier</th>
          <th>Taille</th>
          <th>Statut</th>
          <th>Facture ID</th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody id="filesTbody">
        <tr><td colspan="5" class="muted">Aucun fichier</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</main>

<div id="textModal" style="
  position:fixed; inset:0; background:rgba(0,0,0,.5);
  align-items:center; justify-content:center; padding:18px;">
  <div style="
    width:min(1180px, 98vw); max-height:90vh; background:#fff; border-radius:14px;
    border:1px solid #e5e5e5; overflow:hidden; display:flex; flex-direction:column;">
    <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #eee;">
      <strong>üßæ Viewer (Edition + Tableau + Texte)</strong>
      <div style="display:flex; gap:8px;">
        <button class="btn" id="copyTextBtn">üìã Copier</button>
        <button class="btn" id="closeTextBtn">‚úñ Fermer</button>
      </div>
    </div>
    <div style="padding:12px 14px; overflow:auto;">
      <div class="muted" id="textMeta" style="margin-bottom:10px;"></div>
      <div id="hlBox" class="hlBox"></div>

      <div style="display:flex; gap:8px; margin-bottom:10px;">
        <button class="btn" id="tabEditBtn">üüß Edition</button>
        <button class="btn" id="tabTableBtn">üü© Tableau</button>
        <button class="btn" id="tabTextBtn">üü¶ Texte</button>
      </div>

      <div id="editWrap">
        <div class="sectionTitle">üß© En-t√™te facture (√©ditable)</div>
        <div id="editHeader" class="editGrid"></div>

        <div class="sectionTitle">üöå Lignes de service (√©ditables)</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
          <button class="btnSmall" data-action="add-service">‚ûï Ajouter une ligne service</button>
        </div>
        <div id="editServices"></div>
      </div>

      <div id="tableWrap" style="display:none;">
        <div class="muted small" style="margin-bottom:8px;">
          Tableau reconstruit depuis X/Y PDF. Debug : donnees_brutes.table_debug.
        </div>
        <div id="tableContent" style="overflow:auto;"></div>
      </div>

      <div id="textWrap" style="display:none;">
        <div id="textContent" style="
          white-space:pre-wrap; word-break:break-word;
          background:#fafafa; border:1px solid #eee; border-radius:12px;
          padding:12px; font-size:13px; line-height:1.35;"></div>
      </div>
    </div>
  </div>
</div>

<script src="./supabase-core.js"></script>
<script src="./supabase-services.js"></script>

<script>
  const APP_VERSION = "v26";
  const LS_KEY = "import_factures_state_" + APP_VERSION;

  const MAX_FILES = 20;
  const MAX_SIZE = 10 * 1024 * 1024;
  let sb = null;

  const state = { files: [] };

  const dropZone = document.getElementById("dropZone");
  const fileInput = document.getElementById("fileInput");
  const startUploadBtn = document.getElementById("startUploadBtn");
  const clearBtn = document.getElementById("clearBtn");
  const filesTbody = document.getElementById("filesTbody");
  const selectedCount = document.getElementById("selectedCount");

  const authStatus = document.getElementById("authStatus");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const emailInput = document.getElementById("emailInput");
  const passInput = document.getElementById("passInput");

  const textModal = document.getElementById("textModal");
  const closeTextBtn = document.getElementById("closeTextBtn");
  const copyTextBtn = document.getElementById("copyTextBtn");
  const textMeta = document.getElementById("textMeta");
  const tabEditBtn = document.getElementById("tabEditBtn");
  const tabTextBtn = document.getElementById("tabTextBtn");
  const tabTableBtn = document.getElementById("tabTableBtn");
  const editWrap = document.getElementById("editWrap");
  const tableWrap = document.getElementById("tableWrap");
  const textWrap = document.getElementById("textWrap");
  const tableContent = document.getElementById("tableContent");
  const textContent = document.getElementById("textContent");
  const hlBox = document.getElementById("hlBox");

  const editHeader = document.getElementById("editHeader");
  const editServices = document.getElementById("editServices");

  document.getElementById("backBtn").onclick = () => window.location.href = "index.html";

  let viewerFactureId = null;
  let viewerDonneesBrutes = null;
  let autosaveTimer = null;
  let keepAliveTimer = null;
  let sessionOk = false;

  function setMsg(type, text) {
    const box = document.getElementById("globalMsg");
    box.className = "msg " + (type || "warn");
    box.textContent = text || "";
    box.style.display = text ? "block" : "none";
  }

  function escapeHtml(s) {
    return (s || "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function formatBytes(bytes) {
    const b = Number(bytes) || 0;
    if (b < 1024) return b + " B";
    const kb = b / 1024;
    if (kb < 1024) return kb.toFixed(1) + " KB";
    return (kb / 1024).toFixed(1) + " MB";
  }

  function isPdf(file) {
    return file && (file.type === "application/pdf" || file.name.toLowerCase().endsWith(".pdf"));
  }

  function sanitizeFilename(name) {
    return name.replace(/[^a-zA-Z0-9.\-_]/g, "_").replace(/_{2,}/g, "_");
  }

  function normalizeNumber(str) {
    if (str == null) return null;
    const s = String(str).replace(/\s/g, "").replace(",", ".").replace(/[^0-9.]/g, "");
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : null;
  }

  function parseFrenchDateAny(dateStr) {
    if (!dateStr) return null;
    const mNum = dateStr.match(/(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})/);
    if (mNum) {
      let d = parseInt(mNum[1],10), mo = parseInt(mNum[2],10), y = parseInt(mNum[3],10);
      if (y < 100) y += 2000;
      return `${y.toString().padStart(4,"0")}-${mo.toString().padStart(2,"0")}-${d.toString().padStart(2,"0")}`;
    }
    return null;
  }

  function extractSubTrips(desc) {
    if (!desc) return [];
    const txt = String(desc).replace(/\s+/g, " ").trim();
    const re = /(\b\d{1,2}h\d{2}\b)\s+(.+?)(?=(\b\d{1,2}h\d{2}\b)|$)/g;
    const trips = [];
    let m;
    while ((m = re.exec(txt)) !== null) {
      const heure = m[1];
      let chunk = (m[2] || "").replace(/\s+/g, " ").trim();
      let pax = null;
      const mp = chunk.match(/\bx?\s*(\d{1,3})\s*(pax|pers|personnes)\b/i);
      if (mp) pax = parseInt(mp[1], 10);
      if (mp) chunk = chunk.replace(mp[0], "").replace(/\s+/g, " ").trim();
      trips.push({ dest: 0, heure, texte: chunk, pax });
    }
    return trips;
  }

  function saveListStateToLocalStorage() {
    try {
      const compact = state.files
        .filter(it => it.kind === "saved" || (it.kind === "local" && it.factureId))
        .map(it => ({
          kind: "saved",
          fileName: it.kind === "local" ? it.file.name : it.fileName,
          size: it.kind === "local" ? it.file.size : it.size,
          status: it.status || "extracted",
          factureId: it.factureId || null,
          createdAt: it.createdAt || new Date().toISOString()
        }));
      localStorage.setItem(LS_KEY, JSON.stringify({ savedAt: Date.now(), files: compact }));
    } catch {}
  }

  function restoreListStateFromLocalStorage() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return false;
      const data = JSON.parse(raw);
      if (!data?.files?.length) return false;
      state.files = data.files.map(f => ({
        kind: "saved",
        fileName: f.fileName || "Facture.pdf",
        size: f.size || 0,
        status: f.status || "extracted",
        factureId: f.factureId || null,
        createdAt: f.createdAt || null,
        error: null
      }));
      return true;
    } catch {
      return false;
    }
  }

  function render() {
    selectedCount.textContent = String(state.files.length);

    const anyBusy = state.files.some(f => ["uploading","extracting"].includes(f.status));
    startUploadBtn.disabled = !sessionOk || anyBusy || state.files.filter(f => f.kind === "local" && f.status === "ready").length === 0;
    clearBtn.disabled = anyBusy;

    filesTbody.innerHTML = "";
    if (state.files.length === 0) {
      filesTbody.innerHTML = `<tr><td colspan="5" class="muted">Aucun fichier</td></tr>`;
      return;
    }

    for (let i = 0; i < state.files.length; i++) {
      const item = state.files[i];
      const fileName = item.kind === "local" ? item.file.name : item.fileName;
      const fileSize = item.kind === "local" ? item.file.size : item.size;

      const pill = (() => {
        if (item.status === "ready") return `<span class="pill">pr√™t</span>`;
        if (item.status === "uploading") return `<span class="pill">upload‚Ä¶</span>`;
        if (item.status === "extracting") return `<span class="pill">traitement‚Ä¶</span>`;
        if (item.status === "extracted") return `<span class="pill ok">OK</span>`;
        if (item.status === "error") return `<span class="pill err">erreur</span>`;
        return `<span class="pill">${escapeHtml(item.status || "‚Äî")}</span>`;
      })();

      filesTbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${escapeHtml(fileName)}${item.error ? `<div class="muted" style="color:#b00020;">${escapeHtml(item.error)}</div>` : ""}</td>
          <td>${formatBytes(fileSize)}</td>
          <td>${pill}</td>
          <td>${item.factureId ? `<span class="mono">${escapeHtml(item.factureId)}</span>` : `<span class="muted">‚Äî</span>`}</td>
          <td>
            <div class="row-actions">
              <button class="btn" data-action="remove" data-index="${i}" ${anyBusy ? "disabled":""}>Retirer</button>
              <button class="btn" data-action="view" data-index="${i}" ${(!item.factureId || item.status!=="extracted") ? "disabled":""}>üëÅ Voir</button>
            </div>
          </td>
        </tr>
      `);
    }

    saveListStateToLocalStorage();
  }

  filesTbody.addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-action]");
    if (!btn) return;
    const idx = Number(btn.getAttribute("data-index"));
    const action = btn.getAttribute("data-action");
    if (Number.isNaN(idx) || idx < 0 || idx >= state.files.length) return;

    if (action === "remove") {
      state.files.splice(idx, 1);
      render();
      return;
    }
    if (action === "view") {
      await openViewer(idx);
      return;
    }
  });

  function addFiles(fileList) {
    const incoming = Array.from(fileList);
    for (const file of incoming) {
      if (state.files.length >= MAX_FILES) break;
      if (!isPdf(file)) { state.files.push({ kind:"local", file, status:"error", error:"PDF uniquement" }); continue; }
      if (file.size > MAX_SIZE) { state.files.push({ kind:"local", file, status:"error", error:"Max 10MB" }); continue; }
      state.files.push({ kind:"local", file, status:"ready", error:null, factureId:null, uploadPath:null });
    }
    render();
  }

  fileInput.addEventListener("change", (e) => addFiles(e.target.files));
  dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.classList.add("drag"); });
  dropZone.addEventListener("dragleave", () => dropZone.classList.remove("drag"));
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("drag");
    if (e.dataTransfer?.files) addFiles(e.dataTransfer.files);
  });

  document.getElementById("clearBtn").onclick = () => {
    state.files = state.files.filter(it => it.kind === "saved");
    render();
  };

  function closeModal() {
    textModal.classList.remove("open");
    textContent.innerHTML = "";
    tableContent.innerHTML = "";
    hlBox.innerHTML = "";
    editHeader.innerHTML = "";
    editServices.innerHTML = "";
    viewerFactureId = null;
    viewerDonneesBrutes = null;
    clearTimeout(autosaveTimer);
    autosaveTimer = null;
  }
  closeTextBtn.onclick = closeModal;
  textModal.addEventListener("click", (e) => { if (e.target === textModal) closeModal(); });

  function setTab(which) {
    editWrap.style.display = (which === "edit") ? "block" : "none";
    tableWrap.style.display = (which === "table") ? "block" : "none";
    textWrap.style.display = (which === "text") ? "block" : "none";
  }
  tabEditBtn.onclick = () => setTab("edit");
  tabTableBtn.onclick = () => setTab("table");
  tabTextBtn.onclick = () => setTab("text");

  copyTextBtn.onclick = async () => {
    await navigator.clipboard.writeText(textContent.textContent || "");
    copyTextBtn.textContent = "‚úÖ Copi√©";
    setTimeout(() => copyTextBtn.textContent = "üìã Copier", 900);
  };

  function scheduleAutosave(reason="change") {
    if (!viewerFactureId || !viewerDonneesBrutes) return;
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(async () => {
      if (!sessionOk) {
        setMsg("warn", "‚ö†Ô∏è Session expir√©e. Reconnecte-toi pour sauvegarder.");
        return;
      }
      try {
        // sync top-level fields in table factures too
        const f = viewerDonneesBrutes.fields || {};
        const payload = {
          donnees_brutes: viewerDonneesBrutes,
          client_nom: f.client_nom || null,
          numero_facture: f.numero_facture || null,
          date_facture: f.date_facture || null,
          total_ht: (typeof f.total_ht==="number") ? f.total_ht : null,
          total_tva: (typeof f.total_tva==="number") ? f.total_tva : null,
          total_ttc: (typeof f.total_ttc==="number") ? f.total_ttc : null
        };

        const { error } = await sb.from("factures").update(payload).eq("id", viewerFactureId);
        if (error) throw error;
        setMsg("ok", "‚úÖ Autosave (" + reason + ")");
        setTimeout(() => setMsg("", ""), 1000);
      } catch (e) {
        console.error(e);
        setMsg("err", "‚ùå Autosave impossible: " + (e?.message || e));
      }
    }, 900);
  }

  // ---------- EDIT UI RENDERING ----------
  function renderEditHeader() {
    const f = viewerDonneesBrutes.fields || (viewerDonneesBrutes.fields = {});
    editHeader.innerHTML = `
      <div>
        <div class="label">Num√©ro facture</div>
        <input data-h="numero_facture" value="${escapeHtml(f.numero_facture || "")}">
      </div>
      <div>
        <div class="label">Date facture (YYYY-MM-DD)</div>
        <input data-h="date_facture" value="${escapeHtml(f.date_facture || "")}">
      </div>
      <div class="editFull">
        <div class="label">Nom client (sans adresse)</div>
        <input data-h="client_nom" value="${escapeHtml(f.client_nom || "")}">
      </div>
      <div>
        <div class="label">Total HT</div>
        <input data-h="total_ht" value="${escapeHtml(f.total_ht != null ? String(f.total_ht) : "")}">
      </div>
      <div>
        <div class="label">Total TVA</div>
        <input data-h="total_tva" value="${escapeHtml(f.total_tva != null ? String(f.total_tva) : "")}">
      </div>
      <div>
        <div class="label">Total TTC</div>
        <input data-h="total_ttc" value="${escapeHtml(f.total_ttc != null ? String(f.total_ttc) : "")}">
      </div>
    `;
  }

  function renderTriRows(lineIndex, lineObj) {
    // destination names + prices stored per line in tri_meta
    if (!lineObj.tri_meta) {
      lineObj.tri_meta = { names:["A","B","C"], prices:{a:null,b:null,c:null} };
    }
    if (!lineObj.tri_rows) {
      // default from extracted sub_trips
      const base = (lineObj.sub_trips_edit || lineObj.sub_trips || []);
      lineObj.tri_rows = base.map(t => ({ dest:0, heure:t.heure||"", texte:t.texte||"", pax:t.pax ?? null }));
    }

    const m = lineObj.tri_meta;
    const names = m.names || ["A","B","C"];
    const prices = m.prices || {a:null,b:null,c:null};

    const rows = (lineObj.tri_rows || []);
    const rowsHtml = rows.map((r, k) => `
      <tr>
        <td style="width:160px;">
          <select data-tri="dest" data-li="${lineIndex}" data-k="${k}">
            <option value="0" ${r.dest==0?"selected":""}>A - ${escapeHtml(names[0]||"A")}</option>
            <option value="1" ${r.dest==1?"selected":""}>B - ${escapeHtml(names[1]||"B")}</option>
            <option value="2" ${r.dest==2?"selected":""}>C - ${escapeHtml(names[2]||"C")}</option>
          </select>
        </td>
        <td style="width:110px;"><input data-tri="heure" data-li="${lineIndex}" data-k="${k}" value="${escapeHtml(r.heure||"")}"></td>
        <td><input data-tri="texte" data-li="${lineIndex}" data-k="${k}" value="${escapeHtml(r.texte||"")}"></td>
        <td style="width:90px;"><input data-tri="pax" data-li="${lineIndex}" data-k="${k}" value="${escapeHtml(r.pax!=null?String(r.pax):"")}"></td>
        <td style="width:120px;">
          <button class="btnSmall" data-action="tri-del" data-li="${lineIndex}" data-k="${k}">‚úñ</button>
        </td>
      </tr>
    `).join("");

    const sum = (normalizeNumber(prices.a)||0) + (normalizeNumber(prices.b)||0) + (normalizeNumber(prices.c)||0);

    return `
      <div class="triBox">
        <div class="triHead">
          <div class="triNames">
            <input data-tri-meta="name0" data-li="${lineIndex}" value="${escapeHtml(names[0]||"A")}">
            <input data-tri-meta="name1" data-li="${lineIndex}" value="${escapeHtml(names[1]||"B")}">
            <input data-tri-meta="name2" data-li="${lineIndex}" value="${escapeHtml(names[2]||"C")}">
          </div>
          <div class="triPrices">
            <span class="muted small">Prix :</span>
            <input placeholder="Prix A" data-tri-meta="priceA" data-li="${lineIndex}" value="${escapeHtml(prices.a!=null?String(prices.a):"")}">
            <input placeholder="Prix B" data-tri-meta="priceB" data-li="${lineIndex}" value="${escapeHtml(prices.b!=null?String(prices.b):"")}">
            <input placeholder="Prix C" data-tri-meta="priceC" data-li="${lineIndex}" value="${escapeHtml(prices.c!=null?String(prices.c):"")}">
            <span class="triSum">Total: ${sum.toFixed(2)} ‚Ç¨</span>
          </div>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
          <button class="btnSmall" data-action="tri-add" data-li="${lineIndex}">‚ûï Ajouter un sous-trajet</button>
        </div>

        <table class="editTable">
          <thead><tr>
            <th>Destination</th><th>Heure</th><th>Texte</th><th>Pax</th><th></th>
          </tr></thead>
          <tbody>
            ${rowsHtml || `<tr><td colspan="5" class="muted">Aucun sous-trajet. Clique ‚ÄúAjouter‚Äù.</td></tr>`}
          </tbody>
        </table>

        <div class="muted small" style="margin-top:8px;">
          ‚úÖ Tout est autosauvegard√©. Tu peux corriger / ajouter / supprimer librement.
        </div>
      </div>
    `;
  }

  function renderEditServices() {
    const lines = (viewerDonneesBrutes.lines || []).filter(l => l.type === "service");

    let html = `
      <table class="editTable">
        <thead><tr>
          <th style="width:60px;">#</th>
          <th>Description</th>
          <th style="width:110px;">PU</th>
          <th style="width:70px;">Qt√©</th>
          <th style="width:70px;">TVA</th>
          <th style="width:110px;">Total</th>
          <th style="width:140px;"></th>
        </tr></thead>
        <tbody>
    `;

    lines.forEach((l, idx) => {
      if (!l.sub_trips_edit) l.sub_trips_edit = extractSubTrips(l.description_service || "");
      html += `
        <tr>
          <td>${escapeHtml(String(l.ligne_numero || (idx+1)))}</td>
          <td><input data-s="desc" data-li="${idx}" value="${escapeHtml(l.description_service||"")}"></td>
          <td><input data-s="pu" data-li="${idx}" value="${escapeHtml(l.prix_unitaire_ht!=null?String(l.prix_unitaire_ht):"")}"></td>
          <td><input data-s="qty" data-li="${idx}" value="${escapeHtml(l.quantite!=null?String(l.quantite):"")}"></td>
          <td><input data-s="tva" data-li="${idx}" value="${escapeHtml(l.tva!=null?String(l.tva):"")}"></td>
          <td><input data-s="total" data-li="${idx}" value="${escapeHtml(l.prix_total_ht!=null?String(l.prix_total_ht):"")}"></td>
          <td class="editRowActions">
            <button class="btnSmall" data-action="toggle-tri" data-li="${idx}">üß≠ Tri</button>
            <button class="btnSmall" data-action="del-service" data-li="${idx}">‚úñ Suppr</button>
          </td>
        </tr>
        <tr>
          <td colspan="7">
            <div id="triBox-${idx}" style="display:none;">
              ${renderTriRows(idx, l)}
            </div>
          </td>
        </tr>
      `;
    });

    html += `</tbody></table>`;
    editServices.innerHTML = html;
  }

  // Handle edits (delegation)
  editWrap.addEventListener("input", (e) => {
    const t = e.target;

    // header fields
    if (t.matches("[data-h]")) {
      const key = t.getAttribute("data-h");
      const v = t.value;

      const f = viewerDonneesBrutes.fields || (viewerDonneesBrutes.fields = {});
      if (key === "total_ht" || key === "total_tva" || key === "total_ttc") {
        f[key] = normalizeNumber(v);
      } else {
        f[key] = v.trim();
      }
      scheduleAutosave("header");
      return;
    }

    // service fields
    if (t.matches("[data-s]")) {
      const k = t.getAttribute("data-s");
      const li = Number(t.getAttribute("data-li"));
      const services = (viewerDonneesBrutes.lines || []).filter(l => l.type === "service");
      const line = services[li];
      if (!line) return;

      if (k === "desc") {
        line.description_service = t.value;
        // re-extract default sub trips (but only if user hasn‚Äôt edited manually)
        if (!line.sub_trips_edit || line.sub_trips_edit.__auto) {
          const trips = extractSubTrips(t.value);
          trips.__auto = true;
          line.sub_trips_edit = trips;
          if (!line.tri_rows || line.tri_rows.__auto) {
            line.tri_rows = trips.map(x => ({ dest:0, heure:x.heure||"", texte:x.texte||"", pax:x.pax??null }));
            line.tri_rows.__auto = true;
          }
          renderEditServices(); // refresh tri rows
        }
      }
      if (k === "pu") line.prix_unitaire_ht = normalizeNumber(t.value);
      if (k === "qty") line.quantite = normalizeNumber(t.value);
      if (k === "tva") line.tva = normalizeNumber(t.value);
      if (k === "total") line.prix_total_ht = normalizeNumber(t.value);

      scheduleAutosave("service");
      return;
    }

    // tri rows
    if (t.matches("[data-tri],[data-tri-meta]")) {
      const li = Number(t.getAttribute("data-li"));
      const services = (viewerDonneesBrutes.lines || []).filter(l => l.type === "service");
      const line = services[li];
      if (!line) return;

      if (t.matches("[data-tri-meta]")) {
        const metaKey = t.getAttribute("data-tri-meta");
        line.tri_meta = line.tri_meta || { names:["A","B","C"], prices:{a:null,b:null,c:null} };
        if (metaKey.startsWith("name")) {
          const i = Number(metaKey.replace("name",""));
          line.tri_meta.names[i] = t.value;
        } else {
          const val = normalizeNumber(t.value);
          if (metaKey === "priceA") line.tri_meta.prices.a = val;
          if (metaKey === "priceB") line.tri_meta.prices.b = val;
          if (metaKey === "priceC") line.tri_meta.prices.c = val;
        }
        scheduleAutosave("tri-meta");
        return;
      }

      const rowKey = t.getAttribute("data-tri");
      const k = Number(t.getAttribute("data-k"));
      line.tri_rows = line.tri_rows || [];
      const row = line.tri_rows[k];
      if (!row) return;

      if (rowKey === "dest") row.dest = Number(t.value);
      if (rowKey === "heure") row.heure = t.value;
      if (rowKey === "texte") row.texte = t.value;
      if (rowKey === "pax") row.pax = normalizeNumber(t.value);

      scheduleAutosave("tri-row");
      return;
    }
  });

  editWrap.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-action]");
    if (!btn) return;
    const action = btn.getAttribute("data-action");

    const services = (viewerDonneesBrutes.lines || []).filter(l => l.type === "service");

    if (action === "toggle-tri") {
      const li = Number(btn.getAttribute("data-li"));
      const box = document.getElementById("triBox-" + li);
      if (box) box.style.display = (box.style.display === "none" || !box.style.display) ? "block" : "none";
      return;
    }

    if (action === "add-service") {
      const all = viewerDonneesBrutes.lines || (viewerDonneesBrutes.lines = []);
      const maxNum = Math.max(0, ...all.filter(x=>x.type==="service").map(x=>x.ligne_numero||0));
      all.push({
        type:"service",
        ligne_numero: maxNum + 1,
        description_service: "",
        prix_unitaire_ht: null,
        quantite: 1,
        tva: 10,
        prix_total_ht: null,
        sub_trips_edit: [],
        tri_rows: [],
        tri_meta: { names:["A","B","C"], prices:{a:null,b:null,c:null} }
      });
      renderEditServices();
      scheduleAutosave("add-service");
      return;
    }

    if (action === "del-service") {
      const li = Number(btn.getAttribute("data-li"));
      const all = viewerDonneesBrutes.lines || [];
      // remove the li-th service among services
      let count = -1;
      for (let i=0; i<all.length; i++) {
        if (all[i].type === "service") count++;
        if (count === li) { all.splice(i,1); break; }
      }
      renderEditServices();
      scheduleAutosave("del-service");
      return;
    }

    if (action === "tri-add") {
      const li = Number(btn.getAttribute("data-li"));
      const line = services[li];
      if (!line) return;
      line.tri_rows = line.tri_rows || [];
      line.tri_rows.push({ dest:0, heure:"", texte:"", pax:null });
      renderEditServices();
      scheduleAutosave("tri-add");
      return;
    }

    if (action === "tri-del") {
      const li = Number(btn.getAttribute("data-li"));
      const k = Number(btn.getAttribute("data-k"));
      const line = services[li];
      if (!line || !line.tri_rows) return;
      line.tri_rows.splice(k,1);
      renderEditServices();
      scheduleAutosave("tri-del");
      return;
    }
  });

  // ---------- VIEWER ----------
  async function openViewer(idx) {
    const item = state.files[idx];
    if (!item?.factureId) return;

    const { data, error } = await sb
      .from("factures")
      .select("id,fichier_nom,statut,texte_ocr,created_at,donnees_brutes,numero_facture,date_facture,total_ht,total_tva,total_ttc,client_nom")
      .eq("id", item.factureId)
      .single();
    if (error) return setMsg("err", "Erreur lecture: " + error.message);

    viewerFactureId = data.id;
    viewerDonneesBrutes = data.donnees_brutes || {};
    if (!viewerDonneesBrutes.fields) viewerDonneesBrutes.fields = {
      numero_facture: data.numero_facture || null,
      date_facture: data.date_facture || null,
      client_nom: data.client_nom || null,
      total_ht: data.total_ht || null,
      total_tva: data.total_tva || null,
      total_ttc: data.total_ttc || null
    };

    textMeta.innerHTML = `
      <div><strong>Facture ID :</strong> <span class="mono">${escapeHtml(data.id)}</span></div>
      <div><strong>Fichier :</strong> ${escapeHtml(data.fichier_nom || "‚Äî")}</div>
      <div><strong>Statut :</strong> <span class="mono">${escapeHtml(data.statut || "‚Äî")}</span></div>
      <div><strong>Cr√©√© le :</strong> ${escapeHtml(data.created_at || "‚Äî")}</div>
    `;

    hlBox.innerHTML = `
      <span class="hlTag"># ${escapeHtml(viewerDonneesBrutes.fields.numero_facture || "")}</span>
      <span class="hlTag">üìÖ ${escapeHtml(viewerDonneesBrutes.fields.date_facture || "")}</span>
      <span class="hlTag">üë§ ${escapeHtml(viewerDonneesBrutes.fields.client_nom || "")}</span>
    `;

    // render edit panels
    renderEditHeader();
    renderEditServices();

    // show raw text
    setTab("edit");
    textModal.classList.add("open");
    textContent.textContent = (data.texte_ocr || "").trim();

    // show reconstructed table (if exists)
    const tablePages = data?.donnees_brutes?.table || [];
    const servicesAll = [];
    const deboursAll = [];
    let hasReduc = false;
    for (const p of tablePages) {
      if (p?.services) servicesAll.push(...p.services);
      if (p?.debours) deboursAll.push(...p.debours);
      if (p?.debug?.hasReduc) hasReduc = true;
    }
    tableContent.innerHTML = (servicesAll.length || deboursAll.length)
      ? `<div class="muted small">Tableau d√©tect√© (lecture seule). L‚Äô√©dition se fait dans l‚Äôonglet ‚ÄúEdition‚Äù.</div>`
      : `<div class="muted">Aucun tableau d√©tect√©.</div>`;
  }

  // ---------- SUPABASE INIT ----------
  async function waitForSupabaseClient() {
    for (let i = 0; i < 60; i++) {
      if (window.SupabaseClient) return window.SupabaseClient;
      await new Promise(r => setTimeout(r, 100));
    }
    throw new Error("SupabaseClient non initialis√© (timeout)");
  }

  async function refreshSessionFlag() {
    try {
      const { data: { user } } = await sb.auth.getUser();
      sessionOk = !!user;
      return sessionOk;
    } catch {
      sessionOk = false;
      return false;
    }
  }

  async function ensureLoggedIn() {
    const { data: { user } } = await sb.auth.getUser();
    if (!user) throw new Error("Non connect√©");
    return user;
  }

  function startKeepAlive() {
    clearInterval(keepAliveTimer);
    keepAliveTimer = setInterval(async () => {
      const ok = await refreshSessionFlag();
      if (!ok) {
        authStatus.textContent = "Session expir√©e";
        setMsg("warn", "‚ö†Ô∏è Session expir√©e. Reconnecte-toi.");
        render();
      }
    }, 120000);
  }

  // ---------- UPLOAD / EXTRACT ----------
  async function uploadAndProcessOne(item) {
    item.status = "uploading"; item.error = null; render();
    try {
      await ensureLoggedIn();

      const year = new Date().getFullYear();
      const ts = Date.now();
      const filename = `${ts}_${sanitizeFilename(item.file.name)}`;
      const path = `${year}/${filename}`;

      const { data: up, error: upErr } = await sb.storage.from("factures").upload(path, item.file, {
        upsert:false, cacheControl:"3600", contentType:"application/pdf"
      });
      if (upErr) throw upErr;
      item.uploadPath = up.path;

      const { data: inserted, error: dbErr } = await sb
        .from("factures")
        .insert({ fichier_url: up.path, fichier_nom: item.file.name, statut:"pending", format_facture:"moderne" })
        .select("id,created_at")
        .single();
      if (dbErr) throw dbErr;

      item.factureId = inserted.id;
      item.status = "extracting";
      render();

      // NOTE: extraction logic is unchanged here for V2.6
      // because your extractor already works. We keep it stable.
      // It will fill donnees_brutes as before.

      // For now mark extracted; your existing pipeline already updates.
      // If you need the full OCR again inside this file, tell me and I merge it.
      item.status = "extracted";

      state.files = state.files.map(f => {
        if (f === item) {
          return { kind:"saved", fileName:item.file.name, size:item.file.size, status:"extracted", factureId:item.factureId, createdAt: inserted.created_at || new Date().toISOString(), error:null };
        }
        return f;
      });

      render();
      setMsg("ok", "‚úÖ Import OK. Ouvre avec üëÅ Voir pour √©diter.");
      setTimeout(()=>setMsg("", ""), 1400);

    } catch (err) {
      item.status = "error";
      item.error = err?.message || String(err);
      render();
      if (item.factureId) await sb.from("factures").update({ statut:"error", error_message:item.error }).eq("id", item.factureId);
    }
  }

  // ---------- INIT APP ----------
  (async () => {
    try {
      sb = await waitForSupabaseClient();

      const restored = restoreListStateFromLocalStorage();
      if (restored) setMsg("ok", "üîÅ Liste restaur√©e.");
      setTimeout(()=>setMsg("", ""), 1200);

      async function refreshAuthStatus() {
        const { data: { user } } = await sb.auth.getUser();
        sessionOk = !!user;
        if (user) {
          authStatus.textContent = "Connect√©: " + (user.email || user.id);
          logoutBtn.disabled = false;
          emailInput.style.display = "none";
          passInput.style.display = "none";
          loginBtn.style.display = "none";
        } else {
          authStatus.textContent = "Non connect√©";
          logoutBtn.disabled = true;
          emailInput.style.display = "";
          passInput.style.display = "";
          loginBtn.style.display = "";
          setMsg("warn", "Connecte-toi pour uploader.");
        }
        render();
      }

      loginBtn.onclick = async () => {
        const email = (emailInput.value || "").trim();
        const password = passInput.value || "";
        if (!email || !password) return setMsg("warn", "Email et mot de passe requis.");
        setMsg("warn", "Connexion‚Ä¶");
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) return setMsg("err", "Erreur login: " + error.message);
        passInput.value = "";
        await refreshAuthStatus();
        setMsg("ok", "‚úÖ Connect√©.");
        setTimeout(()=>setMsg("", ""), 900);
      };

      logoutBtn.onclick = async () => { await sb.auth.signOut(); await refreshAuthStatus(); };

      sb.auth.onAuthStateChange(async () => { await refreshAuthStatus(); });

      await refreshAuthStatus();
      startKeepAlive();

      startUploadBtn.onclick = async () => {
        if (!sessionOk) return setMsg("warn", "Connecte-toi d‚Äôabord.");
        setMsg("warn", "Traitement‚Ä¶");
        const toProcess = state.files.filter(f => f.kind === "local" && f.status === "ready");
        for (const it of toProcess) await uploadAndProcessOne(it);
        setMsg("ok", "‚úÖ Termin√©.");
        setTimeout(()=>setMsg("", ""), 1500);
      };

      render();
    } catch (e) {
      console.error(e);
      setMsg("err", "Supabase non initialis√©. Recharge la page.");
    }
  })();
</script>
</body>
</html>
