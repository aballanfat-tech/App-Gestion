<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grille Tarifaire v11.0.19 COMPLETE - Autocars Ballanfat</title>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* ============================================
           VARIABLES CSS & RESET
           ============================================ */
        :root {
            --primary: #1a3c6e;
            --accent: #428bca;
            --bg-light: #f8f9fa;
            --border: #dee2e6;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --text-dark: #212529;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Georgia, 'Times New Roman', serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            padding: 20px;
        }
        
        /* ============================================
           LOGO WATERMARK
           ============================================ */
        body::before {
            content: '';
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 800px;
            height: 400px;
            background: url('logo_ballanfat.png') no-repeat center;
            background-size: contain;
            opacity: 0.04;
            z-index: -1;
            pointer-events: none;
        }
        
        /* ============================================
           HEADER
           ============================================ */
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            align-items: start;
        }
        
        .header-left h1 {
            color: var(--primary);
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .version-badge {
            display: inline-block;
            background: var(--accent);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .header-center {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .header-center label {
            font-weight: bold;
            font-size: 13px;
            color: #666;
        }
        
        .header-center select {
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            font-family: Georgia, serif;
            transition: border-color 0.3s;
        }
        
        .header-center select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .header-right {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s;
            text-align: center;
            font-family: Georgia, serif;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #0f2847;
        }
        
        .btn-accent {
            background: var(--accent);
            color: white;
        }
        
        .btn-accent:hover {
            background: #3276a8;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: #212529;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* ============================================
           MAJORATIONS ZONE
           ============================================ */
        .majorations-container {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .majorations-container h3 {
            color: var(--primary);
            font-size: 16px;
            margin-bottom: 12px;
        }
        
        .majorations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }
        
        .majoration-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .majoration-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .majoration-item label {
            cursor: pointer;
            font-size: 14px;
            user-select: none;
        }
        
        /* ============================================
           SEARCH BAR - POSITION FIXE (BUG #8)
           ============================================ */
        .search-container {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 15px;
        }
        
        .search-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            font-family: Georgia, serif;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .sort-select {
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            font-family: Georgia, serif;
            min-width: 150px;
        }
        
        /* ============================================
           TABLES CONTAINERS
           ============================================ */
        .table-wrapper {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }
        
        .table-title {
            font-size: 18px;
            color: var(--primary);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .table-actions {
            display: flex;
            gap: 8px;
        }
        
        /* ============================================
           TABLES STYLES
           ============================================ */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th {
            background: var(--primary);
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #0f2847;
            font-size: 12px;
        }
        
        td {
            padding: 8px;
            border: 1px solid var(--border);
        }
        
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        tr:hover {
            background: #e9ecef;
        }
        
        /* Colonnes masqu√©es (BUG #12) */
        .column-hidden {
            display: none !important;
        }
        
        /* D√©tection doublons (BUG #3) */
        .row-duplicate {
            background-color: #fff3cd !important;
            border-left: 4px solid var(--warning) !important;
        }
        
        /* ============================================
           INPUTS
           ============================================ */
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: 13px;
            font-family: Georgia, serif;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(66,139,202,0.1);
        }
        
        /* Input montants avec ic√¥ne ‚Ç¨ */
        .price-input {
            position: relative;
        }
        
        .price-input::after {
            content: '‚Ç¨';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 12px;
            pointer-events: none;
        }
        
        /* ============================================
           EVOLUTION BADGES
           ============================================ */
        .evolution {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .evolution-positive {
            background: #d4edda;
            color: #155724;
        }
        
        .evolution-negative {
            background: #f8d7da;
            color: #721c24;
        }
        
        .evolution-neutral {
            background: #e2e3e5;
            color: #383d41;
        }
        
        /* ============================================
           DRAG & DROP
           ============================================ */
        .draggable {
            cursor: grab;
        }
        
        .draggable:active {
            cursor: grabbing;
        }
        
        .drag-handle {
            cursor: grab;
            color: #999;
            margin-right: 8px;
            user-select: none;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
        
        .dragging {
            opacity: 0.5;
            background: #e9ecef;
        }
        
        .drag-over {
            border-top: 3px solid var(--accent);
        }
        
        /* ============================================
           MODALS
           ============================================ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            color: var(--primary);
            font-size: 20px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 2px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* ============================================
           CATEGORIES EDITOR (BUG #13 - Colonnes √©troites)
           ============================================ */
        .categories-table {
            width: 100%;
            max-width: 900px;
        }
        
        .categories-table th,
        .categories-table td {
            padding: 6px 4px;
            font-size: 13px;
        }
        
        .categories-table input[type="text"] {
            width: 90px;
            font-size: 13px;
        }
        
        .categories-table input[type="number"] {
            width: 50px;
            font-size: 13px;
        }
        
        .categories-table input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        /* ============================================
           PDF LINKS (FEATURE #1)
           ============================================ */
        .facture-cell {
            position: relative;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .facture-input {
            flex: 1;
        }
        
        .pdf-link {
            font-size: 16px;
            text-decoration: none;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .pdf-link:hover {
            transform: scale(1.2);
        }
        
        .pdf-link.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .upload-pdf-btn {
            font-size: 14px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            transition: transform 0.2s;
        }
        
        .upload-pdf-btn:hover {
            transform: scale(1.2);
        }
        
        /* ============================================
           NOTIFICATIONS TOAST
           ============================================ */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 300px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast-success {
            border-left: 4px solid var(--success);
        }
        
        .toast-error {
            border-left: 4px solid var(--danger);
        }
        
        .toast-warning {
            border-left: 4px solid var(--warning);
        }
        
        .toast-info {
            border-left: 4px solid var(--accent);
        }
        
        .toast-icon {
            font-size: 24px;
        }
        
        .toast-message {
            flex: 1;
            font-size: 14px;
        }
        
        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #999;
            cursor: pointer;
        }
        
        /* ============================================
           LOADING SPINNER
           ============================================ */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 768px) {
            .header {
                grid-template-columns: 1fr;
            }
            
            .search-row {
                flex-direction: column;
            }
            
            table {
                font-size: 11px;
            }
            
            th, td {
                padding: 6px 4px;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>
    
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <h1>üöå Grille Tarifaire</h1>
            <span class="version-badge">v11.0.19 COMPLETE</span>
            <p style="font-size: 13px; color: #666; margin-top: 5px;">Autocars Ballanfat</p>
        </div>
        
        <div class="header-center">
            <div>
                <label for="selectClient">Client :</label>
                <select id="selectClient">
                    <option value="">S√©lectionner un client...</option>
                    <option value="new">‚ûï Nouveau client</option>
                </select>
            </div>
            
            <div>
                <label for="selectYear">Ann√©e :</label>
                <select id="selectYear">
                    <option value="">S√©lectionner une ann√©e...</option>
                    <option value="new">‚ûï Nouvelle ann√©e</option>
                </select>
            </div>
        </div>
        
        <div class="header-right">
            <button class="btn btn-primary" onclick="saveGrid()">üíæ Sauvegarder</button>
            <button class="btn btn-accent" onclick="openModal('categoriesModal')">‚öôÔ∏è G√©rer cat√©gories</button>
            <button class="btn btn-accent btn-sm" onclick="openModal('importExportModal')">üì• Import/Export</button>
            <button class="btn btn-warning btn-sm" onclick="deleteYear()">üóëÔ∏è Supprimer ann√©e</button>
        </div>
    </div>
    
    <!-- Majorations -->
    <div class="majorations-container">
        <h3>‚≠ê Majorations</h3>
        <div class="majorations-grid">
            <div class="majoration-item">
                <input type="checkbox" id="majNuit" onchange="saveGrid()">
                <label for="majNuit">üåô Nuit</label>
            </div>
            <div class="majoration-item">
                <input type="checkbox" id="majHoraireScolaire" onchange="saveGrid()">
                <label for="majHoraireScolaire">üìö Horaire scolaire</label>
            </div>
            <div class="majoration-item">
                <input type="checkbox" id="majDimanche" onchange="saveGrid()">
                <label for="majDimanche">üìÖ Dimanche</label>
            </div>
            <div class="majoration-item">
                <input type="checkbox" id="majJourFerie" onchange="saveGrid()">
                <label for="majJourFerie">üéâ Jour f√©ri√©</label>
            </div>
        </div>
    </div>
    
    <!-- Search Bar (BUG #8 - Position sticky) -->
    <div class="search-container">
        <div class="search-row">
            <input 
                type="text" 
                id="searchDestinations" 
                class="search-input" 
                placeholder="üîç Rechercher une destination..."
                oninput="filterDestinations()"
            >
            <select id="sortDestinations" class="sort-select" onchange="sortDestinations()">
                <option value="default">Par d√©faut</option>
                <option value="alpha-asc">Nom A ‚Üí Z</option>
                <option value="alpha-desc">Nom Z ‚Üí A</option>
            </select>
        </div>
    </div>
    
    <!-- Destinations Table -->
    <div class="table-wrapper" id="destinationsWrapper">
        <div class="table-header">
            <div class="table-title">
                <span>üìç Destinations</span>
            </div>
            <div class="table-actions">
                <button class="btn btn-success btn-sm" onclick="addDestination()">‚ûï Ajouter</button>
            </div>
        </div>
        <div style="overflow-x: auto;">
            <table id="destinationsTable">
                <thead>
                    <tr id="destinationsTableHeader">
                        <th style="width: 30px;">üîπ</th>
                        <th>Destination</th>
                        <th>Trajet</th>
                        <!-- Colonnes dynamiques cat√©gories -->
                    </tr>
                </thead>
                <tbody id="destinationsBody">
                    <!-- Lignes dynamiques -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Transferts Table -->
    <div class="table-wrapper" id="transfertsWrapper">
        <div class="table-header">
            <div class="table-title">
                <span>üöâ Transferts (Gares/A√©roports)</span>
            </div>
            <div class="table-actions">
                <button class="btn btn-success btn-sm" onclick="addTransfert()">‚ûï Ajouter</button>
            </div>
        </div>
        <div style="overflow-x: auto;">
            <table id="transfertsTable">
                <thead>
                    <tr id="transfertsTableHeader">
                        <th style="width: 30px;">üîπ</th>
                        <th>Destination</th>
                        <th>Trajet</th>
                        <!-- Colonnes dynamiques cat√©gories -->
                    </tr>
                </thead>
                <tbody id="transfertsBody">
                    <!-- Lignes dynamiques -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Custom Tables Container -->
    <div id="customTablesContainer"></div>
    
    <!-- Bouton cr√©er tableau personnalis√© -->
    <div style="text-align: center; margin-top: 20px;">
        <button class="btn btn-accent" onclick="createCustomTable()">‚ûï Nouveau tableau personnalis√©</button>
    </div>
    
    <!-- Modal Cat√©gories -->
    <div id="categoriesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Gestion des cat√©gories</h2>
                <button class="modal-close" onclick="closeModal('categoriesModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: #666;">
                    Personnalisez les cat√©gories de v√©hicules pour cette grille (isol√©es par client/ann√©e).
                </p>
                <table class="categories-table">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Capacit√©</th>
                            <th>Visible</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="categoriesTableBody">
                        <!-- Lignes dynamiques -->
                    </tbody>
                </table>
                <button class="btn btn-success btn-sm" onclick="addCategory()" style="margin-top: 15px;">
                    ‚ûï Ajouter cat√©gorie
                </button>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('categoriesModal')">Annuler</button>
                <button class="btn btn-primary" onclick="saveCategoryChanges()">Enregistrer</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Import/Export -->
    <div id="importExportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì• Import / Export</h2>
                <button class="modal-close" onclick="closeModal('importExportModal')">&times;</button>
            </div>
            <div class="modal-body">
                <h3 style="margin-bottom: 10px;">Export</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 30px;">
                    <button class="btn btn-primary" onclick="exportJSON()">üìÑ Export JSON</button>
                    <button class="btn btn-accent" onclick="exportCSV()">üìä Export CSV</button>
                </div>
                
                <h3 style="margin-bottom: 10px;">Import</h3>
                <input type="file" id="importFile" accept=".json" style="margin-bottom: 10px;">
                <button class="btn btn-success" onclick="importJSON()">üì• Importer JSON</button>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('importExportModal')">Fermer</button>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================
        // CONFIGURATION SUPABASE
        // ============================================
        const SUPABASE_URL = 'https://ayzouplmnnlooofcxbsz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5em91cGxtbm5sb29vZmN4YnN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUzNDQxMTMsImV4cCI6MjA1MDkyMDExM30.xH6dB7GFaTkr8sCUcmRROy_CrDJgqbm1xpFZaXDlcwE';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        console.log('‚úÖ Supabase client initialized');
        
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        const STORAGE_PREFIX = 'ballanfat_grille_v11_0_19::';
        const DEFAULT_TVA = 10;
        
        let currentClient = null;
        let currentYear = null;
        let currentGrid = {
            categories: [],  // NOUVEAU : Cat√©gories par grille (BUG #15)
            destinations: [],
            transferts: [],
            customTables: [],
            majorations: {},
            tva: DEFAULT_TVA
        };
        
        // Cat√©gories par d√©faut (migration anciennes grilles)
        const DEFAULT_CATEGORIES = [
            { id: 'cat_1', name: 'VL', capacity: '< 9 places', visible: true, order: 0 },
            { id: 'cat_2', name: 'Minicar 22', capacity: '22 places', visible: true, order: 1 },
            { id: 'cat_3', name: 'Minicar 33', capacity: '33 places', visible: true, order: 2 },
            { id: 'cat_4', name: 'Autocar 55', capacity: '55 places', visible: true, order: 3 },
            { id: 'cat_5', name: 'Autocar 64', capacity: '64 places', visible: true, order: 4 }
        ];
        
        // ============================================
        // INITIALISATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Initialisation v11.0.19...');
            
            await loadClients();
            setupEventListeners();
            
            console.log('‚úÖ Initialisation termin√©e');
        });
        
        function setupEventListeners() {
            const selectClient = document.getElementById('selectClient');
            const selectYear = document.getElementById('selectYear');
            
            selectClient.addEventListener('change', async (e) => {
                if (e.target.value === 'new') {
                    createNewClient();
                } else if (e.target.value) {
                    currentClient = e.target.value;
                    await loadAvailableYears(currentClient);
                } else {
                    clearInterface(); // BUG #11
                }
            });
            
            selectYear.addEventListener('change', async (e) => {
                if (e.target.value === 'new') {
                    createNewYear();
                } else if (e.target.value) {
                    currentYear = parseInt(e.target.value);
                    await loadGrid(currentClient, currentYear);
                }
            });
        }
        
        // ============================================
        // GESTION CLIENTS
        // ============================================
        async function loadClients() {
            try {
                // Charger depuis Supabase
                const { data, error } = await supabaseClient
                    .from('clients')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                
                const select = document.getElementById('selectClient');
                select.innerHTML = '<option value="">S√©lectionner un client...</option>';
                select.innerHTML += '<option value="new">‚ûï Nouveau client</option>';
                
                if (data && data.length > 0) {
                    data.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id;
                        option.textContent = client.name;
                        select.appendChild(option);
                    });
                    
                    console.log(`‚úÖ ${data.length} clients charg√©s`);
                }
                
                // Fallback localStorage si Supabase vide
                if (!data || data.length === 0) {
                    const localClients = getLocalStorageClients();
                    localClients.forEach(clientName => {
                        const option = document.createElement('option');
                        option.value = clientName;
                        option.textContent = clientName;
                        select.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('Erreur chargement clients:', error);
                showToast('Erreur chargement clients', 'error');
                
                // Fallback localStorage
                const localClients = getLocalStorageClients();
                const select = document.getElementById('selectClient');
                select.innerHTML = '<option value="">S√©lectionner un client...</option>';
                select.innerHTML += '<option value="new">‚ûï Nouveau client</option>';
                
                localClients.forEach(clientName => {
                    const option = document.createElement('option');
                    option.value = clientName;
                    option.textContent = clientName;
                    select.appendChild(option);
                });
            }
        }
        
        function getLocalStorageClients() {
            const clients = new Set();
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(STORAGE_PREFIX)) {
                    const parts = key.replace(STORAGE_PREFIX, '').split('::');
                    if (parts.length >= 1) {
                        clients.add(parts[0]);
                    }
                }
            }
            return Array.from(clients).sort();
        }
        
        async function createNewClient() {
            const name = prompt('Nom du nouveau client :');
            if (!name || !name.trim()) return;
            
            const clientName = name.trim();
            
            try {
                // Cr√©er dans Supabase
                const { data, error } = await supabaseClient
                    .from('clients')
                    .insert({ name: clientName })
                    .select()
                    .single();
                
                if (error) throw error;
                
                console.log('‚úÖ Client cr√©√© dans cloud:', clientName);
                showToast(`Client "${clientName}" cr√©√©`, 'success');
                
                await loadClients();
                
                // S√©lectionner le nouveau client
                const select = document.getElementById('selectClient');
                select.value = data.id;
                currentClient = data.id;
                
                await loadAvailableYears(currentClient);
                clearInterface(); // BUG #11
                
            } catch (error) {
                console.error('Erreur cr√©ation client:', error);
                showToast('Erreur cr√©ation client', 'error');
            }
        }
        
        // ============================================
        // GESTION ANN√âES (BUG #1 et #2 - Persistance + Ordre)
        // ============================================
        async function loadAvailableYears(clientId) {
            try {
                // BUG #1 CORRIG√â : Charger depuis Supabase
                const { data, error } = await supabaseClient
                    .from('grilles')
                    .select('year')
                    .eq('client_id', clientId)
                    .order('year', { ascending: true }); // BUG #2 CORRIG√â : Tri chronologique
                
                if (error) throw error;
                
                let years = [];
                if (data && data.length > 0) {
                    years = [...new Set(data.map(g => g.year))];
                }
                
                // Fallback localStorage
                if (years.length === 0) {
                    years = getLocalStorageYears(clientId);
                }
                
                // Si toujours vide, ajouter ann√©e courante
                if (years.length === 0) {
                    years = [new Date().getFullYear()];
                }
                
                updateYearSelector(years);
                
                console.log(`‚úÖ ${years.length} ann√©es charg√©es pour client`);
                
            } catch (error) {
                console.error('Erreur chargement ann√©es:', error);
                
                // Fallback localStorage
                const years = getLocalStorageYears(clientId);
                updateYearSelector(years.length > 0 ? years : [new Date().getFullYear()]);
            }
        }
        
        function getLocalStorageYears(clientName) {
            const years = new Set();
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(STORAGE_PREFIX + clientName + '::')) {
                    const parts = key.replace(STORAGE_PREFIX, '').split('::');
                    if (parts.length >= 2) {
                        years.add(parseInt(parts[1]));
                    }
                }
            }
            return Array.from(years).sort((a, b) => a - b); // BUG #2 : Tri num√©rique
        }
        
        function updateYearSelector(years) {
            // BUG #2 CORRIG√â : Tri avant affichage
            years.sort((a, b) => a - b);
            
            const select = document.getElementById('selectYear');
            select.innerHTML = '<option value="">S√©lectionner une ann√©e...</option>';
            select.innerHTML += '<option value="new">‚ûï Nouvelle ann√©e</option>';
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                select.appendChild(option);
            });
        }
        
        function createNewYear() {
            const year = prompt('Nouvelle ann√©e (ex: 2026) :');
            if (!year || isNaN(year)) return;
            
            const yearNum = parseInt(year);
            if (yearNum < 2000 || yearNum > 2100) {
                showToast('Ann√©e invalide (2000-2100)', 'error');
                return;
            }
            
            currentYear = yearNum;
            
            // Cr√©er grille vide avec cat√©gories par d√©faut
            currentGrid = {
                categories: JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)), // Clone profond
                destinations: [],
                transferts: [],
                customTables: [],
                majorations: {},
                tva: DEFAULT_TVA
            };
            
            buildGridUI();
            saveGrid(); // Auto-save
            
            showToast(`Ann√©e ${yearNum} cr√©√©e`, 'success');
        }
        
        // BUG #6 CORRIG√â : Suppression ann√©e fonctionnelle
        async function deleteYear() {
            if (!currentClient || !currentYear) {
                showToast('S√©lectionnez un client et une ann√©e', 'warning');
                return;
            }
            
            if (!confirm(`Supprimer d√©finitivement l'ann√©e ${currentYear} pour ce client ?`)) {
                return;
            }
            
            try {
                // Supprimer de Supabase
                const { error } = await supabaseClient
                    .from('grilles')
                    .delete()
                    .eq('client_id', currentClient)
                    .eq('year', currentYear);
                
                if (error) throw error;
                
                // Supprimer de localStorage
                const key = `${STORAGE_PREFIX}${currentClient}::${currentYear}`;
                localStorage.removeItem(key);
                
                console.log(`‚úÖ Ann√©e ${currentYear} supprim√©e`);
                showToast(`Ann√©e ${currentYear} supprim√©e`, 'success');
                
                // Recharger ann√©es
                await loadAvailableYears(currentClient);
                
                // Vider interface
                clearInterface();
                currentYear = null;
                document.getElementById('selectYear').value = '';
                
            } catch (error) {
                console.error('Erreur suppression ann√©e:', error);
                showToast('Erreur suppression ann√©e', 'error');
            }
        }
        
        // ============================================
        // SAUVEGARDE / CHARGEMENT GRILLE
        // ============================================
        async function saveGrid() {
            if (!currentClient || !currentYear) {
                showToast('S√©lectionnez un client et une ann√©e', 'warning');
                return;
            }
            
            // Collecter donn√©es
            collectGridData();
            
            const key = `${STORAGE_PREFIX}${currentClient}::${currentYear}`;
            
            try {
                // 1. localStorage (backup)
                localStorage.setItem(key, JSON.stringify(currentGrid));
                console.log('‚úÖ Sauvegarde locale OK');
                
                // 2. Supabase (cloud)
                const { data, error } = await supabaseClient
                    .from('grilles')
                    .upsert({
                        client_id: currentClient,
                        year: currentYear,
                        data: currentGrid,
                        tva: currentGrid.tva || DEFAULT_TVA
                    })
                    .select();
                
                if (error) throw error;
                
                console.log('‚úÖ Grille sauvegard√©e dans cloud');
                showToast('‚òÅÔ∏è Sauvegarde cloud r√©ussie', 'success');
                
            } catch (error) {
                console.error('Erreur sauvegarde cloud:', error);
                showToast('‚ö†Ô∏è Sauvegard√© localement uniquement', 'warning');
            }
        }
        
        async function loadGrid(clientId, year) {
            try {
                // Essayer Supabase d'abord
                const { data, error } = await supabaseClient
                    .from('grilles')
                    .select('*')
                    .eq('client_id', clientId)
                    .eq('year', year)
                    .single();
                
                if (data && !error) {
                    currentGrid = data.data;
                    
                    // Migration : Ajouter cat√©gories si absentes (anciennes grilles)
                    if (!currentGrid.categories || currentGrid.categories.length === 0) {
                        console.log('üì¶ Migration : Ajout cat√©gories par d√©faut');
                        currentGrid.categories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
                        await saveGrid(); // Sauvegarder migration
                    }
                    
                    buildGridUI();
                    console.log('‚úÖ Grille charg√©e depuis cloud');
                    showToast('Grille charg√©e', 'info');
                    return;
                }
            } catch (error) {
                console.warn('Cloud indisponible, fallback localStorage');
            }
            
            // Fallback localStorage
            const key = `${STORAGE_PREFIX}${clientId}::${year}`;
            const stored = localStorage.getItem(key);
            
            if (stored) {
                currentGrid = JSON.parse(stored);
                
                // Migration cat√©gories
                if (!currentGrid.categories || currentGrid.categories.length === 0) {
                    currentGrid.categories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
                }
                
                buildGridUI();
                console.log('‚úÖ Grille charg√©e depuis localStorage');
            } else {
                // Nouvelle grille
                currentGrid = {
                    categories: JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)),
                    destinations: [],
                    transferts: [],
                    customTables: [],
                    majorations: {},
                    tva: DEFAULT_TVA
                };
                buildGridUI();
            }
        }
        
        function collectGridData() {
            // Collecter majorations
            currentGrid.majorations = {
                nuit: document.getElementById('majNuit').checked,
                horaireScolaire: document.getElementById('majHoraireScolaire').checked,
                dimanche: document.getElementById('majDimanche').checked,
                jourFerie: document.getElementById('majJourFerie').checked
            };
            
            // Destinations
            currentGrid.destinations = [];
            document.querySelectorAll('#destinationsBody tr').forEach(row => {
                const dest = {
                    name: row.querySelector('.dest-name').value,
                    trajet: row.querySelector('.dest-trajet').value,
                    prices: {}
                };
                
                currentGrid.categories.forEach(cat => {
                    const htInput = row.querySelector(`[data-cat-ht="${cat.id}"]`);
                    const ttcInput = row.querySelector(`[data-cat-ttc="${cat.id}"]`);
                    const factInput = row.querySelector(`[data-cat-facture="${cat.id}"]`);
                    
                    if (htInput && ttcInput) {
                        dest.prices[cat.id] = {
                            ht: parseFloat(htInput.value) || 0,
                            ttc: parseFloat(ttcInput.value) || 0,
                            facture: factInput ? factInput.value : ''
                        };
                    }
                });
                
                currentGrid.destinations.push(dest);
            });
            
            // Transferts
            currentGrid.transferts = [];
            document.querySelectorAll('#transfertsBody tr').forEach(row => {
                const trans = {
                    name: row.querySelector('.dest-name').value,
                    trajet: row.querySelector('.dest-trajet').value,
                    prices: {}
                };
                
                currentGrid.categories.forEach(cat => {
                    const htInput = row.querySelector(`[data-cat-ht="${cat.id}"]`);
                    const ttcInput = row.querySelector(`[data-cat-ttc="${cat.id}"]`);
                    const factInput = row.querySelector(`[data-cat-facture="${cat.id}"]`);
                    
                    if (htInput && ttcInput) {
                        trans.prices[cat.id] = {
                            ht: parseFloat(htInput.value) || 0,
                            ttc: parseFloat(ttcInput.value) || 0,
                            facture: factInput ? factInput.value : ''
                        };
                    }
                });
                
                currentGrid.transferts.push(trans);
            });
        }
        
        // BUG #11 CORRIG√â : Vider interface lors cr√©ation nouveau client
        function clearInterface() {
            document.getElementById('destinationsBody').innerHTML = '';
            document.getElementById('transfertsBody').innerHTML = '';
            document.getElementById('customTablesContainer').innerHTML = '';
            
            document.querySelectorAll('.majoration-item input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            console.log('‚úÖ Interface vid√©e');
        }
        
        // ============================================
        // CONSTRUCTION INTERFACE
        // ============================================
        function buildGridUI() {
            buildTableHeaders();
            buildDestinationsTable();
            buildTransfertsTable();
            loadMajorations();
        }
        
        function buildTableHeaders() {
            const destHeader = document.getElementById('destinationsTableHeader');
            const transHeader = document.getElementById('transfertsTableHeader');
            
            const baseHeaders = `
                <th style="width: 30px;">üîπ</th>
                <th>Destination</th>
                <th>Trajet</th>
            `;
            
            let catHeaders = '';
            currentGrid.categories.forEach(cat => {
                const hiddenClass = cat.visible ? '' : 'column-hidden';
                catHeaders += `
                    <th class="${hiddenClass}" data-category="${cat.id}">${cat.name} HT</th>
                    <th class="${hiddenClass}" data-category="${cat.id}">${cat.name} TTC</th>
                    <th class="${hiddenClass}" data-category="${cat.id}" data-facture-header="${cat.id}">N¬∞ Fact. ${cat.name}</th>
                    <th class="${hiddenClass}" data-category="${cat.id}">√âvol. ${cat.name} (%)</th>
                `;
            });
            
            destHeader.innerHTML = baseHeaders + catHeaders + '<th>Note</th><th style="width: 60px;">Actions</th>';
            transHeader.innerHTML = baseHeaders + catHeaders + '<th>Note</th><th style="width: 60px;">Actions</th>';
        }
        
        function buildDestinationsTable() {
            const tbody = document.getElementById('destinationsBody');
            tbody.innerHTML = '';
            
            currentGrid.destinations.forEach((dest, index) => {
                const row = createDestinationRow(dest, index);
                tbody.appendChild(row);
            });
        }
        
        function buildTransfertsTable() {
            const tbody = document.getElementById('transfertsBody');
            tbody.innerHTML = '';
            
            currentGrid.transferts.forEach((trans, index) => {
                const row = createTransfertRow(trans, index);
                tbody.appendChild(row);
            });
        }
        
        function createDestinationRow(dest, index) {
            const row = document.createElement('tr');
            row.draggable = true;
            row.dataset.index = index;
            
            let html = `
                <td class="drag-handle">‚ãÆ‚ãÆ</td>
                <td><input type="text" class="dest-name" value="${dest.name}" oninput="checkDuplicates(); saveGrid();"></td>
                <td><input type="text" class="dest-trajet" value="${dest.trajet || ''}" oninput="saveGrid()"></td>
            `;
            
            currentGrid.categories.forEach(cat => {
                const price = dest.prices[cat.id] || { ht: 0, ttc: 0, facture: '' };
                const hiddenClass = cat.visible ? '' : 'column-hidden';
                
                html += `
                    <td class="${hiddenClass}" data-category="${cat.id}">
                        <input type="number" step="0.01" data-cat-ht="${cat.id}" value="${price.ht}" 
                               oninput="calculateTTC(this, '${cat.id}'); saveGrid();">
                    </td>
                    <td class="${hiddenClass}" data-category="${cat.id}">
                        <input type="number" step="0.01" data-cat-ttc="${cat.id}" value="${price.ttc}" 
                               oninput="calculateHT(this, '${cat.id}'); saveGrid();">
                    </td>
                    <td class="${hiddenClass}" data-category="${cat.id}">
                        <div class="facture-cell">
                            <input type="text" class="facture-input" data-cat-facture="${cat.id}" 
                                   value="${price.facture}" oninput="saveGrid();">
                            <a href="#" class="pdf-link" onclick="openPDF(event, '${price.facture}')">üìÑ</a>
                            <button class="upload-pdf-btn" onclick="uploadPDF(event, '${price.facture}')">üì§</button>
                        </div>
                    </td>
                    <td class="${hiddenClass}" data-category="${cat.id}">
                        <span class="evolution evolution-neutral">-</span>
                    </td>
                `;
            });
            
            html += `
                <td><input type="text" placeholder="Notes..." oninput="saveGrid()"></td>
                <td><button class="btn btn-danger btn-sm" onclick="deleteRow(this)">üóëÔ∏è</button></td>
            `;
            
            row.innerHTML = html;
            
            // Drag & Drop
            setupRowDragDrop(row);
            
            return row;
        }
        
        function createTransfertRow(trans, index) {
            return createDestinationRow(trans, index); // M√™me structure
        }
        
        // ============================================
        // CALCULS HT/TTC
        // ============================================
        function calculateTTC(htInput, catId) {
            const ht = parseFloat(htInput.value) || 0;
            const tva = currentGrid.tva || DEFAULT_TVA;
            const ttc = ht * (1 + tva / 100);
            
            const row = htInput.closest('tr');
            const ttcInput = row.querySelector(`[data-cat-ttc="${catId}"]`);
            if (ttcInput) {
                ttcInput.value = ttc.toFixed(2);
            }
        }
        
        function calculateHT(ttcInput, catId) {
            const ttc = parseFloat(ttcInput.value) || 0;
            const tva = currentGrid.tva || DEFAULT_TVA;
            const ht = ttc / (1 + tva / 100);
            
            const row = ttcInput.closest('tr');
            const htInput = row.querySelector(`[data-cat-ht="${catId}"]`);
            if (htInput) {
                htInput.value = ht.toFixed(2);
            }
        }
        
        // ============================================
        // GESTION CAT√âGORIES (FEATURE #2 + BUG #15)
        // ============================================
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            
            if (modalId === 'categoriesModal') {
                buildCategoriesTable();
            }
            
            modal.classList.add('show');
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('show');
        }
        
        function buildCategoriesTable() {
            const tbody = document.getElementById('categoriesTableBody');
            tbody.innerHTML = '';
            
            currentGrid.categories.forEach((cat, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="text" value="${cat.name}" data-cat-index="${index}" 
                               onchange="updateCategoryName(${index}, this.value)">
                    </td>
                    <td>
                        <input type="text" value="${cat.capacity}" data-cat-index="${index}"
                               onchange="updateCategoryCapacity(${index}, this.value)">
                    </td>
                    <td>
                        <input type="checkbox" ${cat.visible ? 'checked' : ''} 
                               onchange="toggleCategoryVisibility('${cat.id}', this.checked)">
                    </td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteCategory(${index})">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function addCategory() {
            const name = prompt('Nom de la cat√©gorie :');
            if (!name) return;
            
            const capacity = prompt('Capacit√© (ex: 80 places) :');
            if (!capacity) return;
            
            const newCat = {
                id: `cat_${Date.now()}`,
                name: name,
                capacity: capacity,
                visible: true,
                order: currentGrid.categories.length
            };
            
            currentGrid.categories.push(newCat);
            buildCategoriesTable();
            showToast(`Cat√©gorie "${name}" ajout√©e`, 'success');
        }
        
        function deleteCategory(index) {
            if (!confirm('Supprimer cette cat√©gorie ?')) return;
            
            currentGrid.categories.splice(index, 1);
            buildCategoriesTable();
            showToast('Cat√©gorie supprim√©e', 'info');
        }
        
        function updateCategoryName(index, newName) {
            currentGrid.categories[index].name = newName;
        }
        
        function updateCategoryCapacity(index, newCapacity) {
            currentGrid.categories[index].capacity = newCapacity;
        }
        
        // BUG #12 CORRIG√â : Masquer/afficher colonnes
        function toggleCategoryVisibility(catId, visible) {
            const cat = currentGrid.categories.find(c => c.id === catId);
            if (cat) {
                cat.visible = visible;
            }
            
            // Appliquer masquage CSS
            document.querySelectorAll(`[data-category="${catId}"]`).forEach(col => {
                if (visible) {
                    col.classList.remove('column-hidden');
                } else {
                    col.classList.add('column-hidden');
                }
            });
            
            console.log(`Cat√©gorie ${catId} : ${visible ? 'visible' : 'masqu√©e'}`);
        }
        
        // BUG #14 CORRIG√â : Sync cat√©gories ‚Üí headers factures
        function saveCategoryChanges() {
            // Mettre √† jour tous les headers de colonnes factures
            currentGrid.categories.forEach(cat => {
                document.querySelectorAll(`[data-facture-header="${cat.id}"]`).forEach(th => {
                    th.textContent = `N¬∞ Fact. ${cat.name}`;
                });
            });
            
            // Reconstruire tableaux avec nouvelles cat√©gories
            buildTableHeaders();
            
            saveGrid();
            closeModal('categoriesModal');
            showToast('Cat√©gories sauvegard√©es', 'success');
        }
        
        // ============================================
        // GESTION PDFs (FEATURE #1)
        // ============================================
        async function uploadPDF(event, numeroFacture) {
            event.preventDefault();
            
            if (!numeroFacture) {
                showToast('Saisissez d\'abord un num√©ro de facture', 'warning');
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/pdf';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // V√©rifier type
                if (file.type !== 'application/pdf') {
                    showToast('Fichier doit √™tre un PDF', 'error');
                    return;
                }
                
                // V√©rifier taille (10 MB max)
                if (file.size > 10 * 1024 * 1024) {
                    showToast('Fichier trop volumineux (max 10 MB)', 'error');
                    return;
                }
                
                try {
                    showToast('Upload en cours...', 'info');
                    
                    const path = `${currentClient}/${currentYear}/${numeroFacture}.pdf`;
                    
                    const { data, error } = await supabaseClient.storage
                        .from('factures')
                        .upload(path, file, {
                            cacheControl: '3600',
                            upsert: true
                        });
                    
                    if (error) throw error;
                    
                    console.log('‚úÖ PDF upload√©:', path);
                    showToast('‚úÖ Facture PDF enregistr√©e', 'success');
                    
                } catch (error) {
                    console.error('Erreur upload PDF:', error);
                    showToast('Erreur upload PDF', 'error');
                }
            };
            
            input.click();
        }
        
        function openPDF(event, numeroFacture) {
            event.preventDefault();
            
            if (!numeroFacture) {
                showToast('Aucun num√©ro de facture', 'warning');
                return;
            }
            
            const url = `${SUPABASE_URL}/storage/v1/object/public/factures/${currentClient}/${currentYear}/${numeroFacture}.pdf`;
            window.open(url, '_blank');
        }
        
        // ============================================
        // RECHERCHE & TRI (BUG #7 et #9)
        // ============================================
        
        // BUG #3 CORRIG√â : Normalisation compl√®te
        function normalizeString(str) {
            if (!str) return '';
            
            return str
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Supprimer accents
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // BUG #7 CORRIG√â : Recherche insensible accents
        function filterDestinations() {
            const searchTerm = document.getElementById('searchDestinations').value;
            const normalized = normalizeString(searchTerm);
            
            document.querySelectorAll('#destinationsBody tr, #transfertsBody tr').forEach(row => {
                const destName = row.querySelector('.dest-name').value;
                const trajet = row.querySelector('.dest-trajet').value;
                
                const matchName = normalizeString(destName).includes(normalized);
                const matchTrajet = normalizeString(trajet).includes(normalized);
                
                row.style.display = (matchName || matchTrajet) ? '' : 'none';
            });
        }
        
        // BUG #9 CORRIG√â : Option "Par d√©faut" en premier
        function sortDestinations() {
            const sortValue = document.getElementById('sortDestinations').value;
            
            const tbody = document.getElementById('destinationsBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            if (sortValue === 'default') {
                // R√©afficher dans ordre original (index)
                rows.sort((a, b) => {
                    const indexA = parseInt(a.dataset.index) || 0;
                    const indexB = parseInt(b.dataset.index) || 0;
                    return indexA - indexB;
                });
            } else if (sortValue === 'alpha-asc') {
                rows.sort((a, b) => {
                    const nameA = a.querySelector('.dest-name').value.toLowerCase();
                    const nameB = b.querySelector('.dest-name').value.toLowerCase();
                    return nameA.localeCompare(nameB);
                });
            } else if (sortValue === 'alpha-desc') {
                rows.sort((a, b) => {
                    const nameA = a.querySelector('.dest-name').value.toLowerCase();
                    const nameB = b.querySelector('.dest-name').value.toLowerCase();
                    return nameB.localeCompare(nameA);
                });
            }
            
            // R√©ins√©rer lignes dans ordre tri√©
            rows.forEach(row => tbody.appendChild(row));
        }
        
        // BUG #3 CORRIG√â : D√©tection doublons normalis√©e
        function checkDuplicates() {
            const names = new Map();
            
            document.querySelectorAll('#destinationsBody tr').forEach(row => {
                const input = row.querySelector('.dest-name');
                const name = normalizeString(input.value);
                
                if (name) {
                    if (names.has(name)) {
                        row.classList.add('row-duplicate');
                        names.get(name).classList.add('row-duplicate');
                    } else {
                        row.classList.remove('row-duplicate');
                        names.set(name, row);
                    }
                }
            });
        }
        
        // ============================================
        // AJOUT / SUPPRESSION LIGNES
        // ============================================
        function addDestination() {
            const newDest = {
                name: '',
                trajet: '',
                prices: {}
            };
            
            currentGrid.categories.forEach(cat => {
                newDest.prices[cat.id] = { ht: 0, ttc: 0, facture: '' };
            });
            
            currentGrid.destinations.push(newDest);
            
            const row = createDestinationRow(newDest, currentGrid.destinations.length - 1);
            document.getElementById('destinationsBody').appendChild(row);
            
            // Focus sur champ nom
            row.querySelector('.dest-name').focus();
        }
        
        function addTransfert() {
            const newTrans = {
                name: '',
                trajet: '',
                prices: {}
            };
            
            currentGrid.categories.forEach(cat => {
                newTrans.prices[cat.id] = { ht: 0, ttc: 0, facture: '' };
            });
            
            currentGrid.transferts.push(newTrans);
            
            const row = createTransfertRow(newTrans, currentGrid.transferts.length - 1);
            document.getElementById('transfertsBody').appendChild(row);
            
            row.querySelector('.dest-name').focus();
        }
        
        function deleteRow(btn) {
            if (!confirm('Supprimer cette ligne ?')) return;
            
            btn.closest('tr').remove();
            saveGrid();
        }
        
        // ============================================
        // DRAG & DROP
        // ============================================
        function setupRowDragDrop(row) {
            row.addEventListener('dragstart', (e) => {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', row.innerHTML);
                row.classList.add('dragging');
            });
            
            row.addEventListener('dragend', () => {
                row.classList.remove('dragging');
            });
            
            row.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                const tbody = row.parentNode;
                const dragging = tbody.querySelector('.dragging');
                if (dragging && dragging !== row) {
                    const rect = row.getBoundingClientRect();
                    const midpoint = rect.top + rect.height / 2;
                    
                    if (e.clientY < midpoint) {
                        tbody.insertBefore(dragging, row);
                    } else {
                        tbody.insertBefore(dragging, row.nextSibling);
                    }
                }
            });
            
            row.addEventListener('drop', (e) => {
                e.stopPropagation();
                saveGrid();
            });
        }
        
        // ============================================
        // MAJORATIONS
        // ============================================
        function loadMajorations() {
            if (currentGrid.majorations) {
                document.getElementById('majNuit').checked = currentGrid.majorations.nuit || false;
                document.getElementById('majHoraireScolaire').checked = currentGrid.majorations.horaireScolaire || false;
                document.getElementById('majDimanche').checked = currentGrid.majorations.dimanche || false;
                document.getElementById('majJourFerie').checked = currentGrid.majorations.jourFerie || false;
            }
        }
        
        // ============================================
        // IMPORT / EXPORT (BUG #4)
        // ============================================
        function exportJSON() {
            collectGridData();
            
            const dataStr = JSON.stringify(currentGrid, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `grille_${currentClient}_${currentYear}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showToast('Export JSON r√©ussi', 'success');
        }
        
        function exportCSV() {
            collectGridData();
            
            let csv = 'Destination,Trajet';
            currentGrid.categories.forEach(cat => {
                csv += `,${cat.name} HT,${cat.name} TTC,N¬∞ Fact. ${cat.name}`;
            });
            csv += '\n';
            
            currentGrid.destinations.forEach(dest => {
                csv += `"${dest.name}","${dest.trajet}"`;
                currentGrid.categories.forEach(cat => {
                    const price = dest.prices[cat.id] || { ht: 0, ttc: 0, facture: '' };
                    csv += `,${price.ht},${price.ttc},"${price.facture}"`;
                });
                csv += '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `grille_${currentClient}_${currentYear}.csv`;
            a.click();
            
            URL.revokeObjectURL(url);
            showToast('Export CSV r√©ussi', 'success');
        }
        
        // BUG #4 CORRIG√â : Import d√©clenche auto-save
        async function importJSON() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('S√©lectionnez un fichier JSON', 'warning');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    // Migrer cat√©gories si absentes
                    if (!imported.categories) {
                        imported.categories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
                    }
                    
                    currentGrid = imported;
                    buildGridUI();
                    
                    // BUG #4 CORRIG√â : Auto-save apr√®s import
                    await saveGrid();
                    
                    showToast('‚úÖ Grille import√©e et sauvegard√©e', 'success');
                    closeModal('importExportModal');
                    
                } catch (error) {
                    console.error('Erreur import:', error);
                    showToast('Fichier JSON invalide', 'error');
                }
            };
            
            reader.readAsText(file);
        }
        
        // ============================================
        // TABLEAUX PERSONNALIS√âS
        // ============================================
        function createCustomTable() {
            const name = prompt('Nom du tableau personnalis√© :');
            if (!name) return;
            
            const tableWrapper = document.createElement('div');
            tableWrapper.className = 'table-wrapper';
            tableWrapper.innerHTML = `
                <div class="table-header">
                    <div class="table-title">
                        <span>üìã ${name}</span>
                    </div>
                    <div class="table-actions">
                        <button class="btn btn-success btn-sm" onclick="addCustomRow(this)">‚ûï Ajouter</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCustomTable(this)">üóëÔ∏è Supprimer tableau</button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 30px;">üîπ</th>
                                <th>Destination</th>
                                <th>Trajet</th>
                                ${buildCategoryHeaders()}
                                <th>Note</th>
                                <th style="width: 60px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            `;
            
            // BUG #10 CORRIG√â : Ins√©rer APR√àS barre recherche
            const searchContainer = document.querySelector('.search-container');
            searchContainer.parentNode.insertBefore(tableWrapper, searchContainer.nextSibling);
            
            showToast(`Tableau "${name}" cr√©√©`, 'success');
        }
        
        function buildCategoryHeaders() {
            let headers = '';
            currentGrid.categories.forEach(cat => {
                const hiddenClass = cat.visible ? '' : 'column-hidden';
                headers += `
                    <th class="${hiddenClass}" data-category="${cat.id}">${cat.name} HT</th>
                    <th class="${hiddenClass}" data-category="${cat.id}">${cat.name} TTC</th>
                    <th class="${hiddenClass}" data-category="${cat.id}">N¬∞ Fact. ${cat.name}</th>
                    <th class="${hiddenClass}" data-category="${cat.id}">√âvol. ${cat.name} (%)</th>
                `;
            });
            return headers;
        }
        
        function deleteCustomTable(btn) {
            if (!confirm('Supprimer ce tableau ?')) return;
            
            btn.closest('.table-wrapper').remove();
            saveGrid();
        }
        
        function addCustomRow(btn) {
            const tbody = btn.closest('.table-wrapper').querySelector('tbody');
            const row = createDestinationRow({ name: '', trajet: '', prices: {} }, 0);
            tbody.appendChild(row);
        }
        
        // ============================================
        // NOTIFICATIONS TOAST
        // ============================================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            container.appendChild(toast);
            
            // Auto-remove apr√®s 5 secondes
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
        
        // ============================================
        // CONSOLE INFO
        // ============================================
        console.log('%cüöå Grille Tarifaire v11.0.19 COMPLETE', 'color: #1a3c6e; font-size: 18px; font-weight: bold;');
        console.log('%cAutocars Ballanfat - Tous droits r√©serv√©s 2026', 'color: #666; font-size: 12px;');
        console.log('%c15 bugs corrig√©s + 2 fonctionnalit√©s majeures', 'color: #28a745; font-size: 14px; font-weight: bold;');
    </script>
</body>
</html>
